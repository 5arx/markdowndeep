if(Array.prototype.indexOf==undefined){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]===b){return a}}return -1}}var MarkdownDeep=new function(){function v(){this.m_SpanFormatter=new l(this);this.m_SpareBlocks=new Array();this.m_StringBuilder=new k();this.m_LinkDefinitions=new Array();this.SafeMode=false;this.ExtraMode=false;this.MarkdownInHtml=false}var r=v.prototype;r.Transform=function(p){var C=p.indexOf("\r");if(C>=0){var E=p.indexOf("\n");if(E>=0){if(E<C){p=p.replace(/\n\r/g,"\n")}else{p=p.replace(/\r\n/g,"\n")}}p=p.replace(/\r/g,"\n")}this.m_LinkDefinitions.length=0;var B=new h(this,this.MarkdownInHtml).Process(p);var D=this.GetStringBuilder();for(var s=0;s<B.length;s++){var n=B[s];n.Render(this,D)}return D.ToString()};r.AddLinkDefinition=function(b){this.m_LinkDefinitions[b.id]=b};r.GetLinkDefinition=function(i){var b=this.m_LinkDefinitions[i];if(b==undefined){return null}else{return b}};r.GetStringBuilder=function(){this.m_StringBuilder.Clear();return this.m_StringBuilder};r.processSpan=function(p,i,n,b){return this.m_SpanFormatter.Format(p,i,n,b)};var c={};c.is_digit=function(b){return b>="0"&&b<="9"};c.is_hex=function(b){return(b>="0"&&b<="9")||(b>="a"&&b<="f")||(b>="A"&&b<="F")};c.is_alpha=function(b){return(b>="a"&&b<="z")||(b>="A"&&b<="Z")};c.is_alphadigit=function(b){return(b>="a"&&b<="z")||(b>="A"&&b<="Z")||(b>="0"&&b<="9")};c.is_whitespace=function(b){return(b==" "||b=="\t"||b=="\r"||b=="\n")};c.is_linespace=function(b){return(b==" "||b=="\t")};c.is_lineend=function(b){return(b=="\r"||b=="\n")};c.is_emphasis=function(b){return(b=="*"||b=="_")};c.is_escapable=function(b){switch(b){case"\\":case"`":case"*":case"_":case"{":case"}":case"[":case"]":case"(":case")":case"#":case"+":case"-":case".":case"!":case">":return true}return false};function y(i,n){if(i.charAt(n)!="&"){return -1}var b=n;n++;if(i.charAt(n)=="#"){n++;if(i.charAt(n)=="x"||i.charAt(n)=="X"){n++;fn_test=c.is_hex}else{fn_test=c.is_digit}}else{fn_test=c.is_alphadigit}if(fn_test(i.charAt(n))){n++;while(fn_test(i.charAt(n))){n++}if(i.charAt(n)==";"){n++;return n}}n=b;return -1}function q(s){var n=s.indexOf("\\");if(n<0){return s}var i=new k();var p=0;while(n>=0){if(c.is_escapable(s.charAt(n+1))){if(n>p){i.Append(s.substr(p,n-p))}p=n+1}n=s.indexOf("\\",n+1)}if(p<s.length){i.Append(s.substr(p,s.length-p))}return i.ToString()}function A(p){var n=0;var b=p.length;while(n<b&&c.is_whitespace(p.charAt(n))){n++}while(b-1>n&&c.is_whitespace(p.charAt(n-1))){n--}return p.substr(n,b-n)}function g(n){var b=n.indexOf("@");if(b<0){return false}var i=n.lastIndexOf(".");if(i<b){return false}return true}function a(b){b=b.toLowerCase();if(b.substr(0,7)=="http://"){return true}if(b.substr(0,8)=="https://"){return true}if(b.substr(0,6)=="ftp://"){return true}if(b.substr(0,7)=="file://"){return true}return false}function k(){this.content=new Array()}r=k.prototype;r.Append=function(b){if(b){this.content.push(b)}};r.Clear=function(){this.content.length=0};r.ToString=function(){return this.content.join("")};r.HtmlRandomize=function(p){var n=p.length;for(var s=0;s<n;s++){var b=Math.random();if(b>0.9&&p.charAt(s)!="@"){this.Append(p.charAt(s))}else{if(b>0.45){this.Append("&#");this.Append(p.charCodeAt(s).toString());this.Append(";")}else{this.Append("&#x");this.Append(p.charCodeAt(s).toString(16));this.Append(";")}}}};r.HtmlEncode=function(C,b,B){var n=b+B;var s=b;for(var p=b;p<n;p++){switch(C.charAt(p)){case"&":if(p>s){this.Append(C.substr(s,p-s))}this.Append("&amp;");s=p+1;break;case"<":if(p>s){this.Append(C.substr(s,p-s))}this.Append("&lt;");s=p+1;break;case">":if(p>s){this.Append(C.substr(s,p-s))}this.Append("&gt;");s=p+1;break;case'"':if(p>s){this.Append(C.substr(s,p-s))}this.Append("&quot;");s=p+1;break}}if(p>s){this.Append(C.substr(s,p-s))}};r.SmartHtmlEncodeAmpsAndAngles=function(D,b,B){var n=b+B;var s=b;for(var p=b;p<n;p++){switch(D.charAt(p)){case"&":var C=y(D,p);if(C<0){if(p>s){this.Append(D.substr(s,p-s))}this.Append("&amp;");s=p+1}else{p=C-1}break;case"<":if(p>s){this.Append(D.substr(s,p-s))}this.Append("&lt;");s=p+1;break;case">":if(p>s){this.Append(D.substr(s,p-s))}this.Append("&gt;");s=p+1;break;case'"':if(p>s){this.Append(D.substr(s,p-s))}this.Append("&quot;");s=p+1;break}}if(p>s){this.Append(D.substr(s,p-s))}};r.SmartHtmlEncodeAmps=function(D,b,B){var n=b+B;var s=b;for(var p=b;p<n;p++){switch(D.charAt(p)){case"&":var C=y(D,p);if(C<0){if(p>s){this.Append(D.substr(s,p-s))}this.Append("&amp;");s=p+1}else{p=C-1}break}}if(p>s){this.Append(D.substr(s,p-s))}};r.HtmlEncodeAndConvertTabsToSpaces=function(C,b,B){var n=b+B;var s=b;var D=0;for(var p=b;p<n;p++){switch(C.charAt(p)){case"\t":if(p>s){this.Append(C.substr(s,p-s))}s=p+1;this.Append(" ");D++;while((D%4)!=0){this.Append(" ");D++}D--;break;case"&":if(p>s){this.Append(C.substr(s,p-s))}this.Append("&amp;");s=p+1;break;case"<":if(p>s){this.Append(C.substr(s,p-s))}this.Append("&lt;");s=p+1;break;case">":if(p>s){this.Append(C.substr(s,p-s))}this.Append("&gt;");s=p+1;break;case'"':if(p>s){this.Append(C.substr(s,p-s))}this.Append("&quot;");s=p+1;break}D++}if(p>s){this.Append(C.substr(s,p-s))}};function j(){this.reset.apply(this,arguments)}r=j.prototype;r.bof=function(){return this.position==this.start};r.eof=function(){return this.position>=this.end};r.eol=function(){if(this.position>=this.end){return true}var b=this.buf.charAt(this.position);return b=="\r"||b=="\n"||b==undefined||b==""};r.reset=function(){this.buf=arguments.length>0?arguments[0]:null;this.start=arguments.length>1?arguments[1]:0;this.end=arguments.length>2?this.start+arguments[2]:(this.buf==null?0:this.buf.length);this.position=this.start;this.charset_offsets={}};r.current=function(){if(this.position>=this.end){return"\0"}return this.buf.charAt(this.position)};r.remainder=function(){return this.buf.substr(this.position)};r.SkipToEof=function(){this.position=this.end};r.SkipForward=function(b){this.position+=b};r.SkipToEol=function(){this.position=this.buf.indexOf("\n",this.position);if(this.position<0){this.position=this.end}};r.SkipEol=function(){var b=this.position;if(this.buf.charAt(this.position)=="\r"){this.position++}if(this.buf.charAt(this.position)=="\n"){this.position++}return this.position!=b};r.SkipToNextLine=function(){this.SkipToEol();this.SkipEol()};r.CharAtOffset=function(b){if(this.position+b>=this.end){return"\0"}return this.buf.charAt(this.position+b)};r.SkipChar=function(b){if(this.buf.charAt(this.position)==b){this.position++;return true}return false};r.SkipString=function(b){if(this.buf.substr(this.position,b.length)==b){this.position+=b.length;return true}return false};r.SkipWhitespace=function(){var i=this.position;while(true){var b=this.buf.charAt(this.position);if(b!=" "&&b!="\t"&&b!="\r"&&b!="\n"){break}this.position++}return this.position!=i};r.SkipLinespace=function(){var i=this.position;while(true){var b=this.buf.charAt(this.position);if(b!=" "&&b!="\t"){break}this.position++}return this.position!=i};r.FindRE=function(i){i.lastIndex=this.position;var b=i.exec(this.buf);if(b==null){this.position=this.end;return false}if(b.index+b[0].length>this.end){this.position=this.end;return false}this.position=b.index;return true};r.FindOneOf=function(p){var i=-1;for(var b in p){var n=p[b];if(n==null){n={};n.searched_from=-1;n.found_at=-1;p[b]=n}if(n.searched_from==-1||this.position<n.searched_from||(this.position>=n.found_at&&n.found_at!=-1)){n.searched_from=this.position;n.found_at=this.buf.indexOf(b,this.position)}if(i==-1||n.found_at<i){i=n.found_at}}if(i==-1){i=this.end;return false}r.position=i;return true};r.Find=function(b){this.position=this.buf.indexOf(b,this.position);if(this.position<0){this.position=this.end;return false}return true};r.Mark=function(){this.mark=this.position};r.Extract=function(){if(this.mark>=this.position){return""}else{return this.buf.substr(this.mark,this.position-this.mark)}};r.SkipIdentifier=function(){var b=this.buf.charAt(this.position);if((b>="a"&&b<="z")||(b>="A"&&b<="Z")||b=="_"){this.position++;while(true){var b=this.buf.charAt(this.position);if((b>="a"&&b<="z")||(b>="A"&&b<="Z")||b=="_"||(b>="0"&&b<="9")){this.position++}else{return true}}}return false};r.SkipHtmlEntity=function(){if(this.buf.charAt(this.position)!="&"){return false}var b=y(this.buf,this.position);if(b<0){return false}this.position=b;return true};r.SkipEscapableChar=function(){if(this.buf.charAt(this.position)=="\\"&&c.is_escapable(this.buf.charAt(this.position+1))){this.position+=2;return true}else{if(this.position<this.end){this.position++}return false}};HtmlTagFlags={};HtmlTagFlags.Block=1;HtmlTagFlags.Inline=2;HtmlTagFlags.NoClosing=4;HtmlTagFlags.ContentAsSpan=8;function d(b){this.name=b;this.attributes={};this.flags=0}r=d.prototype;r.attributes=null;r.closed=false;r.closing=false;r.attributeCount=function(){if(!this.attributes){return 0}var i=0;for(var b in this.attributes){i++}return i};r.get_Flags=function(){if(this.flags==0){this.flags=tag_flags[this.name.toLowerCase()];if(this.flags==undefined){this.flags=HtmlTagFlags.Inline}}return this.flags};r.IsSafe=function(){var b=this.name.toLowerCase();if(!allowed_tags[b]){return false}var p=allowed_attributes[b];if(!p){return this.attributeCount()==0}if(!this.attributes){return true}for(var n in this.attributes){if(!p[n.toLowerCase()]){return false}}if(this.attributes.href){if(!d.IsSafeUrl(this.attributes.href)){return false}}if(this.attributes.src){if(!d.IsSafeUrl(this.attributes.src)){return false}}return true};r.RenderOpening=function(b){b.Append("<");b.Append(this.name);for(var n in this.m_attributes){b.Append(" ");b.Append(n);b.Append('="');b.Append(this.m_attributes[n]);b.Append('"')}b.Append(">\n")};r.RenderClosing=function(b){b.Append("</");b.Append(this.name);b.Append(">\n")};d.IsSafeUrl=function(b){b=b.toLowerCase();return(b.substr(0,7)=="http://"||b.substr(0,8)=="https://"||b.substr(0,6)=="ftp://")};d.Parse=function(n){var i=n.position;var b=this.ParseHelper(n);if(b!=null){return b}n.position=i;return null};d.ParseHelper=function(B){if(B.current()!="<"){return null}B.SkipForward(1);if(B.SkipString("!--")){B.Mark();if(B.Find("-->")){var n=new d("!");n.attributes.content=B.Extract();n.closed=true;B.SkipForward(3);return n}}var s=B.SkipChar("/");B.Mark();if(!B.SkipIdentifier()){return null}var b=new d(B.Extract());b.closing=s;if(s){if(B.current()!=">"){return null}B.SkipForward(1);return b}while(!B.eof()){B.SkipWhitespace();if(B.SkipString("/>")){b.closed=true;return b}if(B.SkipChar(">")){return b}B.Mark();if(!B.SkipIdentifier()){return null}var i=B.Extract();B.SkipWhitespace();if(!B.SkipChar("=")){return null}B.SkipWhitespace();if(B.SkipChar('"')){B.Mark();if(!B.Find('"')){return null}b.attributes[i]=B.Extract();B.SkipForward(1)}else{B.Mark();while(!B.eof()&&!c.is_whitespace(B.current())&&B.current()!=">"&&B.current()!="/"){B.SkipForward(1)}if(!B.eof()){b.attributes[i]=B.Extract()}}}return null};allowed_tags={b:1,blockquote:1,code:1,dd:1,dt:1,dl:1,del:1,em:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,i:1,kbd:1,li:1,ol:1,ul:1,p:1,pre:1,s:1,sub:1,sup:1,strong:1,strike:1,img:1,a:1};allowed_attributes={a:{href:1,title:1},img:{src:1,width:1,height:1,alt:1,title:1}};var z=HtmlTagFlags.Block;var x=HtmlTagFlags.Inline;var w=HtmlTagFlags.NoClosing;var m=HtmlTagFlags.ContentAsSpan;tag_flags={p:z|m,div:z,h1:z|m,h2:z|m,h3:z|m,h4:z|m,h5:z|m,h6:z|m,blockquote:z,pre:z,table:z,dl:z,ol:z,ul:z,form:z,fieldset:z,iframe:z,script:z|x,noscript:z|x,math:z|x,ins:z|x,del:z|x,img:z|x,li:m,dd:m,dt:m,td:m,th:m,legend:m,address:m,hr:z|w,"!":z|w};delete z;delete x;delete w;function f(n,b,i){this.id=n;this.url=b;if(i==undefined){this.title=null}else{this.title=i}}r=f.prototype;r.RenderLink=function(n,i,p){if(this.url.substr(0,7).toLowerCase()=="mailto:"){i.Append('<a href="');i.HtmlRandomize(this.url);i.Append('"');if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(">");i.HtmlRandomize(p);i.Append("</a>")}else{i.Append('<a href="');i.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);i.Append('"');if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(">");i.Append(p);i.Append("</a>")}};r.RenderImg=function(n,i,p){i.Append('<img src="');i.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);i.Append('"');if(p){i.Append(' alt="');i.SmartHtmlEncodeAmpsAndAngles(p,0,p.length);i.Append('"')}if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(" />")};f.ParseLinkDefinition=function(n){var i=n.position;var b=f.ParseLinkDefinitionInternal(n);if(b==null){n.position=i}return b};f.ParseLinkDefinitionInternal=function(i){i.SkipWhitespace();if(!i.SkipChar("[")){return null}i.Mark();if(!i.Find("]")){return null}var n=i.Extract();if(n.length==0){return null}if(!i.SkipString("]:")){return null}var b=this.ParseLinkTarget(i,n);i.SkipLinespace();if(!i.eol()){return null}return b};f.ParseLinkTarget=function(C,B){C.SkipWhitespace();if(C.eol()){return null}var b=new f(B);if(C.SkipChar("<")){C.Mark();while(C.current()!=">"){if(C.eof()){return null}C.SkipEscapableChar()}var s=C.Extract();if(!C.SkipChar(">")){return null}b.url=q(A(s));C.SkipWhitespace()}else{C.Mark();var n=1;while(!C.eol()){var i=C.current();if(c.is_whitespace(i)){break}if(B==null){if(i=="("){n++}else{if(i==")"){n--;if(n==0){break}}}}C.SkipEscapableChar()}b.url=q(A(C.Extract()))}C.SkipLinespace();if(C.current()==")"){return b}var G=C.eol();var F=C.position;if(C.eol()){C.SkipEol();C.SkipLinespace()}var E;switch(C.current()){case"'":case'"':E=C.current();break;case"(":E=")";break;default:if(G){C.position=F;return b}else{return null}}C.SkipForward(1);C.Mark();while(true){if(C.eol()){return null}if(C.current()==E){if(E!=")"){var D=C.position;C.SkipForward(1);C.SkipLinespace();if((B==null&&C.current()!=")")||(B!=null&&!C.eol())){continue}C.position=D}break}C.SkipEscapableChar()}b.title=q(C.Extract());C.SkipForward(1);return b};function e(i,b){this.def=i;this.link_text=b}TokenType={};TokenType.Text=0;TokenType.HtmlTag=1;TokenType.Html=2;TokenType.open_em=3;TokenType.close_em=4;TokenType.open_strong=5;TokenType.close_strong=6;TokenType.code_span=7;TokenType.br=8;TokenType.link=9;TokenType.img=10;TokenType.opening_mark=11;TokenType.closing_mark=12;TokenType.internal_mark=13;function o(i,b,n){this.type=i;this.startOffset=b;this.length=n;this.data=null}function l(b){this.m_Markdown=b;this.m_Scanner=new j();this.m_SpareTokens=new Array();this.DisableLinks=false}r=l.prototype;r.Format=function(n,B,C,b){this.m_Scanner.reset(B,C,b);var s=this.Tokenize();if(s==null){n.HtmlEncode(B,C,b)}else{this.RenderTokens(n,B,s);for(var p=0;p<s.length;p++){this.FreeToken(s[p])}}};r.FormatDirect=function(i){var b=new k();this.Format(b,i,0,i.length);return b.ToString()};r.RenderTokens=function(E,D,C){var n=C.length;for(var s=0;s<n;s++){var p=C[s];switch(p.type){case TokenType.Text:E.HtmlEncode(D,p.startOffset,p.length);break;case TokenType.HtmlTag:E.SmartHtmlEncodeAmps(D,p.startOffset,p.length);break;case TokenType.Html:case TokenType.opening_mark:case TokenType.closing_mark:case TokenType.internal_mark:E.Append(D.substr(p.startOffset,p.length));break;case TokenType.br:E.Append("<br />\n");break;case TokenType.open_em:E.Append("<em>");break;case TokenType.close_em:E.Append("</em>");break;case TokenType.open_strong:E.Append("<strong>");break;case TokenType.close_strong:E.Append("</strong>");break;case TokenType.code_span:E.Append("<code>");E.HtmlEncode(D,p.startOffset,p.length);E.Append("</code>");break;case TokenType.link:var b=p.data;var B=new l(this.m_Markdown);B.DisableLinks=true;b.def.RenderLink(this.m_Markdown,E,B.FormatDirect(b.link_text));break;case TokenType.img:var b=p.data;b.def.RenderImg(this.m_Markdown,E,b.link_text);break}}};r.Tokenize=function(){var i=this.m_Scanner;var D=null;var b=null;var F=/[\*\_\`\[\!\<\&\ \\]/g;var E=i.position;while(!i.eof()){if(!i.FindRE(F)){break}var B=i.position;var s=null;switch(i.current()){case"*":case"_":s=this.CreateEmphasisMark();switch(s.type){case TokenType.internal_mark:case TokenType.opening_mark:case TokenType.closing_mark:if(b==null){b=new Array()}b.push(s);break}break;case"`":s=this.ProcessCodeSpan();break;case"[":case"!":var n=i.position;s=this.ProcessLinkOrImage();if(s==null){i.position=n}break;case"<":var C=i.position;var G=d.Parse(i);if(G!=null){if(!this.m_Markdown.SafeMode||G.IsSafe()){s=this.CreateToken(TokenType.HtmlTag,C,i.position-C)}else{i.position=C}}else{i.position=C;s=this.ProcessAutoLink();if(s==null){i.position=C}}break;case"&":var C=i.position;if(i.SkipHtmlEntity()){s=this.CreateToken(TokenType.Html,C,i.position-C)}break;case" ":if(i.CharAtOffset(1)==" "&&c.is_lineend(i.CharAtOffset(2))){i.SkipForward(2);if(!i.eof()){i.SkipEol();s=this.CreateToken(TokenType.br,B,0)}}break;case"\\":if(c.is_escapable(i.CharAtOffset(1))){s=this.CreateToken(TokenType.Text,i.position+1,1);i.SkipForward(2)}break}if(s!=null){if(D==null){D=new Array()}if(B>E){D.push(this.CreateToken(TokenType.Text,E,B-E))}D.push(s);E=i.position}else{i.SkipForward(1)}}if(D==null){return null}if(i.position>E){D.push(this.CreateToken(TokenType.Text,E,i.position-E))}if(b!=null){this.ResolveEmphasisMarks(D,b)}return D};r.CreateEmphasisMark=function(){var D=this.m_Scanner;var n=D.current();var C=n=="*"?"_":"*";var B=D.position;if(D.bof()||c.is_whitespace(D.CharAtOffset(-1))){while(c.is_emphasis(D.current())){D.SkipForward(1)}if(D.eof()||c.is_whitespace(D.current())){return this.CreateToken(TokenType.Html,B,D.position-B)}D.position=B}while(c.is_emphasis(D.CharAtOffset(-1))){D.SkipForward(-1)}var b=D.bof()||c.is_whitespace(D.CharAtOffset(-1));D.position=B;while(D.current()==n){D.SkipForward(1)}var s=D.position-B;while(c.is_emphasis(D.CharAtOffset(1))){D.SkipForward(1)}var i=D.eof()||c.is_whitespace(D.CharAtOffset(1));D.position=B+s;if(b){return this.CreateToken(TokenType.opening_mark,B,D.position-B)}if(i){return this.CreateToken(TokenType.closing_mark,B,D.position-B)}return this.CreateToken(TokenType.internal_mark,B,D.position-B)};r.SplitMarkToken=function(s,n,i,b){var p=this.CreateToken(i.type,i.startOffset+b,i.length-b);i.length=b;n.splice(n.indexOf(i)+1,0,p);s.splice(s.indexOf(i)+1,0,p);return p};r.ResolveEmphasisMarks=function(C,E){var F=this.m_Scanner.buf;var D=true;while(D){D=false;for(var s=0;s<E.length;s++){var B=E[s];if(B.type!=TokenType.opening_mark&&B.type!=TokenType.internal_mark){continue}for(var p=s+1;p<E.length;p++){var n=E[p];if(n.type!=TokenType.closing_mark&&n.type!=TokenType.internal_mark){break}if(F.charAt(B.startOffset)!=F.charAt(n.startOffset)){continue}var b=Math.min(B.length,n.length);if(b>=3){b=(b%2)==1?1:2}if(B.length>b){B=this.SplitMarkToken(C,E,B,B.length-b);s--}if(n.length>b){this.SplitMarkToken(C,E,n,b)}B.type=b==1?TokenType.open_em:TokenType.open_strong;n.type=b==1?TokenType.close_em:TokenType.close_strong;E.splice(E.indexOf(B),1);E.splice(E.indexOf(n),1);D=true;break}}}};r.ProcessAutoLink=function(){if(this.DisableLinks){return null}var B=this.m_Scanner;B.SkipForward(1);B.Mark();while(!B.eof()){var s=B.current();if(c.is_whitespace(s)){break}if(s==">"){var n=q(B.Extract());var b=null;if(g(n)){var i;if(n.toLowerCase().substr(0,7)=="mailto:"){i=n.substr(7)}else{i=n;n="mailto:"+n}b=new e(new f("auto",n,null),i)}else{if(a(n)){b=new e(new f("auto",n,null),n)}}if(b!=null){B.SkipForward(1);return this.CreateDataToken(TokenType.link,b)}return null}B.SkipEscapableChar()}return null};r.ProcessLinkOrImage=function(){if(this.DisableLinks){return null}var B=this.m_Scanner;var J=B.SkipChar("!")?TokenType.img:TokenType.link;if(!B.SkipChar("[")){return null}B.Mark();var I=1;while(!B.eof()){var b=B.current();if(b=="["){I++}else{if(b=="]"){I--;if(I==0){break}}}B.SkipEscapableChar()}if(B.eof()){return null}var n=q(B.Extract());B.SkipForward(1);var D=B.position;if(B.SkipChar("(")){var G=f.ParseLinkTarget(B,null);if(G==null){return null}B.SkipWhitespace();if(!B.SkipChar(")")){return null}return this.CreateDataToken(J,new e(G,n))}if(!B.SkipChar(" ")){B.SkipChar("\t")}if(B.eol()){B.SkipEol();B.SkipLinespace()}var E=null;if(B.current()=="["){B.SkipForward(1);B.Mark();if(!B.Find("]")){return null}E=B.Extract();B.SkipForward(1)}else{B.position=D}if(!E){E=n;while(true){var H=E.indexOf("\n");if(H<0){break}var s=H;while(s>0&&c.is_whitespace(E.charAt(s-1))){s--}var F=H;while(F<E.length&&c.is_whitespace(E.charAt(F))){F++}E=E.substr(0,s)+" "+E.substr(F)}}var C=this.m_Markdown.GetLinkDefinition(E);if(C==null){return null}return this.CreateDataToken(J,new e(C,n))};r.ProcessCodeSpan=function(){var B=this.m_Scanner;var C=B.position;var n=0;while(B.SkipChar("`")){n++}B.SkipWhitespace();if(B.eof()){return this.CreateToken(TokenType.Text,C,B.position-C)}var i=B.position;if(!B.Find(B.buf.substr(C,n))){return this.CreateToken(TokenType.Text,C,B.position-C)}var s=B.position+n;while(c.is_whitespace(B.CharAtOffset(-1))){B.SkipForward(-1)}var b=this.CreateToken(TokenType.code_span,i,B.position-i);B.position=s;return b};r.CreateToken=function(n,b,p){if(this.m_SpareTokens.length!=0){var i=this.m_SpareTokens.pop();i.type=n;i.startOffset=b;i.length=p;i.data=null;return i}else{return new o(n,b,p)}};r.CreateDataToken=function(i,n){if(this.m_SpareTokens.length!=0){var b=this.m_SpareTokens.pop();b.type=i;b.data=n;return b}else{var b=new o(i,0,0);b.data=n;return b}};r.FreeToken=function(b){b.data=null;this.m_SpareTokens.push(b)};BlockType={};BlockType.Blank=0;BlockType.h1=1;BlockType.h2=2;BlockType.h3=3;BlockType.h4=4;BlockType.h5=5;BlockType.h6=6;BlockType.post_h1=7;BlockType.post_h2=8;BlockType.quote=9;BlockType.ol_li=10;BlockType.ul_li=11;BlockType.p=12;BlockType.indent=13;BlockType.hr=14;BlockType.html=15;BlockType.unsafe_html=16;BlockType.span=17;BlockType.codeblock=18;BlockType.li=19;BlockType.ol=20;BlockType.ul=21;BlockType.HtmlTag=22;BlockType.Composite=23;function u(){}r=u.prototype;r.buf=null;r.blockType=BlockType.Blank;r.contentStart=0;r.contentLen=0;r.lineStart=0;r.lineLen=0;r.children=null;r.data=null;r.get_Content=function(){if(this.buf==null){return null}if(this.contentStart==-1){return this.buf}return this.buf.substr(this.contentStart,this.contentLen)};r.get_CodeContent=function(){var n=new k();for(var b=0;b<this.children.length;b++){n.Append(this.children[b].get_Content());n.Append("\n")}return n.ToString()};r.RenderChildren=function(p,n){for(var s=0;s<this.children.length;s++){this.children[s].Render(p,n)}};r.Render=function(p,n){switch(this.blockType){case BlockType.Blank:return;case BlockType.p:n.Append("<p>");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</p>\n");break;case BlockType.span:p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("\n");break;case BlockType.h1:case BlockType.h2:case BlockType.h3:case BlockType.h4:case BlockType.h5:case BlockType.h6:n.Append("<h"+(this.blockType-BlockType.h1+1).toString()+">");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</h"+(this.blockType-BlockType.h1+1).toString()+">\n");break;case BlockType.hr:n.Append("<hr />\n");return;case BlockType.ol_li:case BlockType.ul_li:n.Append("<li>");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</li>\n");break;case BlockType.html:n.Append(this.buf.substr(this.contentStart,this.contentLen));return;case BlockType.unsafe_html:n.HtmlEncode(this.buf,this.contentStart,this.contentLen);return;case BlockType.codeblock:n.Append("<pre><code>");for(var B=0;B<this.children.length;B++){var s=this.children[B];n.HtmlEncodeAndConvertTabsToSpaces(s.buf,s.contentStart,s.contentLen);n.Append("\n")}n.Append("</code></pre>\n\n");return;case BlockType.quote:n.Append("<blockquote>\n");this.RenderChildren(p,n);n.Append("</blockquote>\n");return;case BlockType.li:n.Append("<li>\n");this.RenderChildren(p,n);n.Append("</li>\n");return;case BlockType.ol:n.Append("<ol>\n");this.RenderChildren(p,n);n.Append("</ol>\n");return;case BlockType.ul:n.Append("<ul>\n");this.RenderChildren(p,n);n.Append("</ul>\n");return;case BlockType.HtmlTag:this.data.RenderOpening(n);this.RenderChildren(p,n);this.data.RenderClosing(n);return;case BlockType.Composite:this.RenderChildren(p,n);return}};r.RevertToPlain=function(){this.blockType=BlockType.p;this.contentStart=this.lineStart;this.contentLen=this.lineLen};r.get_contentEnd=function(){return this.contentStart+this.contentLen};r.set_contentEnd=function(b){this.contentLen=b-this.contentStart};r.get_leadingSpaces=function(){var n=0;for(var b=this.lineStart;b<this.lineStart+this.lineLen;b++){if(this.buf.charAt(b)==" "){n++}else{break}}return n};r.CopyFrom=function(b){this.blockType=b.blockType;this.buf=b.buf;this.contentStart=b.contentStart;this.contentLen=b.contentLen;this.lineStart=b.lineStart;this.lineLen=b.lineLen;return this};function h(b,i){this.m_Markdown=b;this.m_parentType=BlockType.Blank;this.m_bMarkdownInHtml=i}r=h.prototype;r.Process=function(i){var b=new j(i);return this.ScanLines(b)};r.ProcessRange=function(s,i,b){var n=new j(s,i,b);return this.ScanLines(n)};r.ScanLines=function(B){var C=new Array();var n=new Array();while(!B.eof()){var i=this.EvaluateLine(B);if(i.blockType==BlockType.post_h1||i.blockType==BlockType.post_h2){if(n.length>0){var D=n.pop();this.CollapseLines(C,n);if(D.blockType!=BlockType.Blank){D.RevertToPlain();D.blockType=i.blockType==BlockType.post_h1?BlockType.h1:BlockType.h2;C.push(D);continue}}if(i.blockType==BlockType.post_h1){i.RevertToPlain();n.push(i)}else{if(i.contentLen>=3){i.blockType=BlockType.hr;C.push(i)}else{i.RevertToPlain();n.push(i)}}continue}var s=n.length>0?n[0].blockType:BlockType.Blank;switch(i.blockType){case BlockType.Blank:switch(s){case BlockType.Blank:this.FreeBlock(i);break;case BlockType.p:this.CollapseLines(C,n);this.FreeBlock(i);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:n.push(i);break}break;case BlockType.p:switch(s){case BlockType.Blank:case BlockType.p:n.push(i);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:var D=n[n.length-1];if(D.blockType==BlockType.Blank){this.CollapseLines(C,n);n.push(i)}else{n.push(i)}break;case BlockType.indent:this.CollapseLines(C,n);n.push(i);break}break;case BlockType.indent:switch(s){case BlockType.Blank:n.push(i);break;case BlockType.p:case BlockType.quote:var D=n[n.length-1];if(D.blockType==BlockType.Blank){this.CollapseLines(C,n);n.push(i)}else{i.RevertToPlain();n.push(i)}break;case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:n.push(i);break}break;case BlockType.quote:if(s!=BlockType.quote){this.CollapseLines(C,n)}n.push(i);break;case BlockType.ol_li:case BlockType.ul_li:switch(s){case BlockType.Blank:n.push(i);break;case BlockType.p:case BlockType.quote:var D=n[n.length-1];if(D.blockType==BlockType.Blank||this.m_parentType==BlockType.ol_li||this.m_parentType==BlockType.ul_li){this.CollapseLines(C,n);n.push(i)}else{i.RevertToPlain();n.push(i)}break;case BlockType.ol_li:case BlockType.ul_li:if(i.blockType!=s){this.CollapseLines(C,n)}n.push(i);break;case BlockType.indent:this.CollapseLines(C,n);n.push(i);break}break;default:this.CollapseLines(C,n);C.push(i);break}}this.CollapseLines(C,n);return C};r.CreateBlock=function(){if(this.m_Markdown.m_SpareBlocks.length>1){return this.m_Markdown.m_SpareBlocks.pop()}else{return new u()}};r.FreeBlock=function(i){this.m_Markdown.m_SpareBlocks.push(i)};r.FreeBlocks=function(n){for(var b=0;b<n.length;b++){this.m_Markdown.m_SpareBlocks.push(n[b])}n.length=0};r.RenderLines=function(s){var n=this.m_Markdown.GetStringBuilder();for(var B=0;B<s.length;B++){var p=s[B];n.Append(p.buf.substr(p.contentStart,p.contentLen));n.Append("\n")}return n.ToString()};r.CollapseLines=function(E,n){while(n.length>0&&n[n.length-1].blockType==BlockType.Blank){this.FreeBlock(n.pop())}if(n.length==0){return}switch(n[0].blockType){case BlockType.p:var b=this.CreateBlock();b.blockType=BlockType.p;b.buf=n[0].buf;b.contentStart=n[0].contentStart;b.set_contentEnd(n[n.length-1].get_contentEnd());E.push(b);this.FreeBlocks(n);break;case BlockType.quote:var D=this.RenderLines(n);var C=new h(this.m_Markdown,this.m_bMarkdownInHtml);C.m_parentType=BlockType.quote;var p=this.CreateBlock();p.blockType=BlockType.quote;p.children=C.Process(D);this.FreeBlocks(n);E.push(p);break;case BlockType.ol_li:case BlockType.ul_li:E.push(this.BuildList(n));break;case BlockType.indent:var B=this.CreateBlock();B.blockType=BlockType.codeblock;B.children=new Array();for(var s=0;s<n.length;s++){B.children.push(n[s])}E.push(B);n.length=0;break}};r.EvaluateLine=function(n){var i=this.CreateBlock();i.lineStart=n.position;i.buf=n.buf;i.contentStart=n.position;i.contentLen=-1;i.blockType=this.EvaluateLineInternal(n,i);if(i.contentLen<0){n.SkipToEol();i.contentLen=n.position-i.contentStart}i.lineLen=n.position-i.lineStart;n.SkipEol();return i};r.EvaluateLineInternal=function(s,H){if(s.eol()){return BlockType.Blank}var C=s.position;var i=s.current();if(i=="#"){var n=1;s.SkipForward(1);while(s.current()=="#"){n++;s.SkipForward(1)}if(n>6){n=6}s.SkipWhitespace();H.contentStart=s.position;s.SkipToEol();while(s.position>H.contentStart&&s.CharAtOffset(-1)=="#"){s.SkipForward(-1)}while(s.position>H.contentStart&&c.is_whitespace(s.CharAtOffset(-1))){s.SkipForward(-1)}H.contentLen=s.position-H.contentStart;s.SkipToEol();return BlockType.h1+(n-1)}if(i=="-"||i=="="){var F=i;while(s.current()==F){s.SkipForward(1)}s.SkipLinespace();if(s.eol()){return F=="="?BlockType.post_h1:BlockType.post_h2}s.position=C}var E=-1;var B=0;while(!s.eol()){if(s.current()==" "){if(E<0){B++}}else{if(s.current()=="\t"){if(E<0){E=s.position}}else{break}}s.SkipForward(1)}if(s.eol()){H.contentLen=0;return BlockType.Blank}if(B>=4){H.contentStart=C+4;return BlockType.indent}if(E>=0&&E-C<4){H.contentStart=E+1;return BlockType.indent}H.contentStart=s.position;i=s.current();if(i=="<"){if(this.ScanHtml(s,H)){return H.blockType}s.position=H.contentStart}if(i==">"){if(c.is_linespace(s.CharAtOffset(1))){s.SkipForward(2);H.contentStart=s.position;return BlockType.quote}s.SkipForward(1);H.contentStart=s.position;return BlockType.quote}if(i=="-"||i=="_"||i=="*"){var G=0;while(!s.eol()){var F=s.current();if(s.current()==i){G++;s.SkipForward(1);continue}if(c.is_linespace(s.current())){s.SkipForward(1);continue}break}if(s.eol()&&G>=3){return BlockType.hr}s.position=H.contentStart}if((i=="*"||i=="+"||i=="-")&&c.is_linespace(s.CharAtOffset(1))){s.SkipForward(1);s.SkipLinespace();H.contentStart=s.position;return BlockType.ul_li}if(c.is_digit(i)){s.SkipForward(1);while(c.is_digit(s.current())){s.SkipForward(1)}if(s.SkipChar(".")&&s.SkipLinespace()){H.contentStart=s.position;return BlockType.ol_li}s.position=H.contentStart}if(i=="["){var D=f.ParseLinkDefinition(s);if(D!=null){this.m_Markdown.AddLinkDefinition(D);return BlockType.Blank}}return BlockType.p};var t={};t.NA=0;t.Block=1;t.Span=2;t.Deep=3;t.Off=4;r.GetMarkdownMode=function(b){var i=b.attributes.markdown;if(i==undefined){if(this.m_bMarkdownInHtml){return t.Deep}else{return t.NA}}delete b.attributes.markdown;if(i=="1"){return(b.get_Flags()&HtmlTagFlags.ContentAsSpan)!=0?t.Span:t.Block}if(i=="block"){return t.Block}if(i=="deep"){return t.Deep}if(i=="span"){return t.Span}return t.Off};r.ProcessMarkdownEnabledHtml=function(n,F,D,E){var B=n.position;var C=1;var s=false;while(!n.eof()){if(!n.Find("<")){break}var I=n.position;var H=d.Parse(n);if(H==null){n.SkipForward(1);continue}if(this.m_Markdown.SafeMode&&E==t.Off&&!s){if(!H.IsSafe()){s=true}}if(H.closed){continue}if(H.name==D.name){if(H.closing){C--;if(C==0){n.SkipLinespace();n.SkipEol();F.blockType=BlockType.HtmlTag;F.data=D;F.contentEnd=n.position;switch(E){case t.Span:var G=this.CreateBlock();G.buf=n.buf;G.blockType=BlockType.span;G.contentStart=B;G.contentLen=I-B;F.children=new Array();F.children.push(G);break;case t.Block:case t.Deep:var i=new h(this.m_Markdown,E==t.Deep);F.children=i.ProcessRange(n.buf,B,I-B);break;case t.Off:if(s){F.blockType=BlockType.unsafe_html;F.contentEnd=n.position}else{var G=this.CreateBlock();G.buf=n.buf;G.blockType=BlockType.html;G.contentStart=B;G.contentLen=I-B;F.children=new Array();F.children.push(G)}break}return true}}else{C++}}}return false};r.ScanHtml=function(n,H){var I=n.position;var E=d.Parse(n);if(E==null){return false}if(E.closing){return false}var s=false;if(this.m_Markdown.SafeMode&&!E.IsSafe()){s=true}var B=E.get_Flags();if((B&HtmlTagFlags.Block)==0){return false}if((B&HtmlTagFlags.NoClosing)!=0||E.closed){n.SkipLinespace();n.SkipEol();H.contentLen=n.position-H.contentStart;H.blockType=s?BlockType.unsafe_html:BlockType.html;return true}if((B&HtmlTagFlags.Inline)!=0){n.SkipLinespace();if(!n.eol()){return false}}if(this.m_Markdown.ExtraMode){var J=this.GetMarkdownMode(E);if(J!=t.NA){return this.ProcessMarkdownEnabledHtml(n,H,E,J)}}var C=null;var D=1;while(!n.eof()){if(!n.Find("<")){break}var F=n.position;var K=d.Parse(n);if(K==null){n.SkipForward(1);continue}if(this.m_Markdown.SafeMode&&!K.IsSafe()){s=true}if(K.closed){continue}if(!K.closing&&this.m_Markdown.ExtraMode&&!s){var J=this.GetMarkdownMode(K);if(J!=t.NA){var i=this.CreateBlock();if(this.ProcessMarkdownEnabledHtml(n,i,K,J)){if(C==null){C=new Array()}if(F>I){var G=this.CreateBlock();G.buf=n.buf;G.blockType=BlockType.html;G.contentStart=I;G.contentLen=F-I;C.push(G)}C.push(i);I=n.position;continue}else{this.FreeBlock(i)}}}if(K.name==E.name&&!K.closed){if(K.closing){D--;if(D==0){n.SkipLinespace();n.SkipEol();if(s){H.blockType=BlockType.unsafe_html;H.contentEnd=n.position;return true}if(C!=null){if(n.position>I){var G=this.CreateBlock();G.buf=n.buf;G.blockType=BlockType.html;G.contentStart=I;G.contentLen=n.position-I;C.push(G)}H.blockType=BlockType.Composite;H.contentEnd=n.position;H.children=C;return true}H.blockType=BlockType.html;H.contentLen=n.position-H.contentStart;return true}}else{D++}}}return BlockType.Blank};r.BuildList=function(L){var I=L[0].blockType;var F=L[0].get_leadingSpaces();for(var B=1;B<L.length;B++){if((L[B].blockType==BlockType.p)&&(L[B-1].blockType==BlockType.p||L[B-1].blockType==I)){L[B-1].set_contentEnd(L[B].get_contentEnd());this.FreeBlock(L[B]);L.splice(B,1);B--;continue}if(L[B].blockType!=BlockType.indent&&L[B].blockType!=BlockType.Blank){var M=L[B].get_leadingSpaces();if(M>F){L[B].blockType=BlockType.indent;var H=L[B].get_contentEnd();L[B].contentStart=L[B].lineStart+M;L[B].set_contentEnd(H)}}}var K=this.CreateBlock();K.blockType=(I==BlockType.ul_li?BlockType.ul:BlockType.ol);K.children=new Array();for(var B=0;B<L.length;B++){var C=B;while(C>0&&L[C-1].blockType==BlockType.Blank){C--}var E=B;while(E<L.length-1&&L[E+1].blockType!=I){E++}if(C==E){K.children.push(this.CreateBlock().CopyFrom(L[B]))}else{var D=false;var G=this.m_Markdown.GetStringBuilder();for(var s=C;s<=E;s++){var p=L[s];G.Append(p.buf.substr(p.contentStart,p.contentLen));G.Append("\n");if(L[s].blockType==BlockType.Blank){D=true}}var J=this.CreateBlock();J.blockType=BlockType.li;var b=new h(this.m_Markdown);b.m_parentType=I;J.children=b.Process(G.ToString());if(!D){for(var B=0;B<J.children.length;B++){var n=J.children[B];if(n.blockType==BlockType.p){n.blockType=BlockType.span}}}K.children.push(J)}B=E}this.FreeBlocks(L);L.length=0;return K};this.Markdown=v;this.StringBuilder=k;this.SpanFormatter=l;this.StringScanner=j;this.BlockProcessor=h;this.LinkDefinition=f;this.HtmlTag=d;this.HtmlTagFlags=HtmlTagFlags;this.UnescapeString=q;this.BlockType=BlockType}();