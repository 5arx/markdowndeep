if(Array.prototype.indexOf==undefined){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]===b){return a}}return -1}}var MarkdownDeep=new function(){function k(){this.m_SpanFormatter=new m(this);this.m_SpareBlocks=new Array();this.m_StringBuilder=new r();this.m_LinkDefinitions=new Array()}var d=k.prototype;d.Transform=function(s){var v=s.indexOf("\r");if(v>=0){var x=s.indexOf("\n");if(x>=0){if(x<v){s=s.replace(/\n\r/g,"\n")}else{s=s.replace(/\r\n/g,"\n")}}s=s.replace(/\r/g,"\n")}this.m_LinkDefinitions.length=0;var u=new e(this).Process(s);var w=this.GetStringBuilder();for(var t=0;t<u.length;t++){var p=u[t];p.Render(this,w)}return w.ToString()};d.AddLinkDefinition=function(p){this.m_LinkDefinitions[p.id]=p};d.GetLinkDefinition=function(s){var p=this.m_LinkDefinitions[s];if(p==undefined){return null}else{return p}};d.GetStringBuilder=function(){this.m_StringBuilder.Clear();return this.m_StringBuilder};d.processSpan=function(u,s,t,p){return this.m_SpanFormatter.Format(u,s,t,p)};var f={};f.is_digit=function(p){return p>="0"&&p<="9"};f.is_hex=function(p){return(p>="0"&&p<="9")||(p>="a"&&p<="f")||(p>="A"&&p<="F")};f.is_alpha=function(p){return(p>="a"&&p<="z")||(p>="A"&&p<="Z")};f.is_alphadigit=function(p){return(p>="a"&&p<="z")||(p>="A"&&p<="Z")||(p>="0"&&p<="9")};f.is_whitespace=function(p){return(p==" "||p=="\t"||p=="\r"||p=="\n")};f.is_linespace=function(p){return(p==" "||p=="\t")};f.is_lineend=function(p){return(p=="\r"||p=="\n")};f.is_emphasis=function(p){return(p=="*"||p=="_")};f.is_escapable=function(p){switch(p){case"\\":case"`":case"*":case"_":case"{":case"}":case"[":case"]":case"(":case")":case"#":case"+":case"-":case".":case"!":case">":return true}return false};function h(s,t){if(s.charAt(t)!="&"){return -1}var p=t;t++;if(s.charAt(t)=="#"){t++;if(s.charAt(t)=="x"||s.charAt(t)=="X"){t++;fn_test=f.is_hex}else{fn_test=f.is_digit}}else{fn_test=f.is_alphadigit}if(fn_test(s.charAt(t))){t++;while(fn_test(s.charAt(t))){t++}if(s.charAt(t)==";"){t++;return t}}t=p;return -1}function g(u){var s=u.indexOf("\\");if(s<0){return u}var p=new r();var t=0;while(s>=0){if(f.is_escapable(u.charAt(s+1))){if(s>t){p.Append(u.substr(t,s-t))}t=s+1}s=u.indexOf("\\",s+1)}if(t<u.length){p.Append(u.substr(t,u.length-t))}return p.ToString()}function l(t){var s=0;var p=t.length;while(s<p&&f.is_whitespace(t.charAt(s))){s++}while(p-1>s&&f.is_whitespace(t.charAt(s-1))){s--}return t.substr(s,p-s)}function j(t){var p=t.indexOf("@");if(p<0){return false}var s=t.lastIndexOf(".");if(s<p){return false}return true}function n(p){p=p.toLowerCase();if(p.substr(0,7)=="http://"){return true}if(p.substr(0,8)=="https://"){return true}if(p.substr(0,6)=="ftp://"){return true}if(p.substr(0,7)=="file://"){return true}return false}function r(){this.content=new Array()}d=r.prototype;d.Append=function(p){if(p){this.content.push(p)}};d.Clear=function(){this.content.length=0};d.ToString=function(){return this.content.join("")};d.HtmlRandomize=function(t){var s=t.length;for(var u=0;u<s;u++){var p=Math.random();if(p>0.9&&t.charAt(u)!="@"){this.Append(t.charAt(u))}else{if(p>0.45){this.Append("&#");this.Append(t.charCodeAt(u).toString());this.Append(";")}else{this.Append("&#x");this.Append(t.charCodeAt(u).toString(16));this.Append(";")}}}};d.HtmlEncode=function(w,p,v){var s=p+v;var u=p;for(var t=p;t<s;t++){switch(w.charAt(t)){case"&":if(t>u){this.Append(w.substr(u,t-u))}this.Append("&amp;");u=t+1;break;case"<":if(t>u){this.Append(w.substr(u,t-u))}this.Append("&lt;");u=t+1;break;case">":if(t>u){this.Append(w.substr(u,t-u))}this.Append("&gt;");u=t+1;break;case'"':if(t>u){this.Append(w.substr(u,t-u))}this.Append("&quot;");u=t+1;break}}if(t>u){this.Append(w.substr(u,t-u))}};d.SmartHtmlEncodeAmpsAndAngles=function(x,p,v){var s=p+v;var u=p;for(var t=p;t<s;t++){switch(x.charAt(t)){case"&":var w=h(x,t);if(w<0){if(t>u){this.Append(x.substr(u,t-u))}this.Append("&amp;");u=t+1}else{t=w-1}break;case"<":if(t>u){this.Append(x.substr(u,t-u))}this.Append("&lt;");u=t+1;break;case">":if(t>u){this.Append(x.substr(u,t-u))}this.Append("&gt;");u=t+1;break;case'"':if(t>u){this.Append(x.substr(u,t-u))}this.Append("&quot;");u=t+1;break}}if(t>u){this.Append(x.substr(u,t-u))}};d.SmartHtmlEncodeAmps=function(x,p,v){var s=p+v;var u=p;for(var t=p;t<s;t++){switch(x.charAt(t)){case"&":var w=h(x,t);if(w<0){if(t>u){this.Append(x.substr(u,t-u))}this.Append("&amp;");u=t+1}else{t=w-1}break}}if(t>u){this.Append(x.substr(u,t-u))}};d.HtmlEncodeAndConvertTabsToSpaces=function(w,p,v){var s=p+v;var u=p;var x=0;for(var t=p;t<s;t++){switch(w.charAt(t)){case"\t":if(t>u){this.Append(w.substr(u,t-u))}u=t+1;this.Append(" ");x++;while((x%4)!=0){this.Append(" ");x++}x--;break;case"&":if(t>u){this.Append(w.substr(u,t-u))}this.Append("&amp;");u=t+1;break;case"<":if(t>u){this.Append(w.substr(u,t-u))}this.Append("&lt;");u=t+1;break;case">":if(t>u){this.Append(w.substr(u,t-u))}this.Append("&gt;");u=t+1;break;case'"':if(t>u){this.Append(w.substr(u,t-u))}this.Append("&quot;");u=t+1;break}x++}if(t>u){this.Append(w.substr(u,t-u))}};function q(){this.reset.apply(this,arguments)}d=q.prototype;d.bof=function(){return this.position==this.start};d.eof=function(){return this.position>=this.end};d.eol=function(){var p=this.buf.charAt(this.position);return p=="\r"||p=="\n"||p==undefined||p==""};d.reset=function(){this.buf=arguments.length>0?arguments[0]:null;this.start=arguments.length>1?arguments[1]:0;this.end=arguments.length>2?this.start+arguments[2]:(this.buf==null?0:this.buf.length);this.position=this.start};d.current=function(){if(this.position>=this.end){return"\0"}return this.buf.charAt(this.position)};d.remainder=function(){return this.buf.substr(this.position)};d.SkipToEof=function(){this.position=this.end};d.SkipForward=function(p){this.position+=p};d.SkipToEol=function(){this.position=this.buf.indexOf("\n",this.position);if(this.position<0){this.position=this.end}};d.SkipEol=function(){var p=this.position;if(this.buf.charAt(this.position)=="\r"){this.position++}if(this.buf.charAt(this.position)=="\n"){this.position++}return this.position!=p};d.SkipToNextLine=function(){this.SkipToEol();this.SkipEol()};d.CharAtOffset=function(p){if(this.position+p>=this.end){return"\0"}return this.buf.charAt(this.position+p)};d.SkipChar=function(p){if(this.buf.charAt(this.position)==p){this.position++;return true}return false};d.SkipString=function(p){if(this.buf.substr(this.position,p.length)==p){this.position+=p.length;return true}return false};d.SkipWhitespace=function(){var s=this.position;while(true){var p=this.buf.charAt(this.position);if(p!=" "&&p!="\t"&&p!="\r"&&p!="\n"){break}this.position++}return this.position!=s};d.SkipLinespace=function(){var s=this.position;while(true){var p=this.buf.charAt(this.position);if(p!=" "&&p!="\t"){break}this.position++}return this.position!=s};d.Find=function(p){this.position=this.buf.indexOf(p,this.position);if(this.position<0){this.position=this.end;return false}return true};d.Mark=function(){this.mark=this.position};d.Extract=function(){if(this.mark>=this.position){return""}else{return this.buf.substr(this.mark,this.position-this.mark)}};d.SkipIdentifier=function(){var p=this.buf.charAt(this.position);if((p>="a"&&p<="z")||(p>="A"&&p<="Z")||p=="_"){this.position++;while(true){var p=this.buf.charAt(this.position);if((p>="a"&&p<="z")||(p>="A"&&p<="Z")||p=="_"||(p>="0"&&p<="9")){this.position++}else{return true}}}return false};d.SkipHtmlEntity=function(){if(this.buf.charAt(this.position)!="&"){return false}var p=h(this.buf,this.position);if(p<0){return false}this.position=p;return true};d.SkipEscapableChar=function(){if(this.buf.charAt(this.position)=="\\"&&f.is_escapable(this.buf.charAt(this.position+1))){this.position+=2;return true}else{if(this.position<this.end){this.position++}return false}};function b(p){this.name=p;this.attributes={}}b.IsSafeUrl=function(p){p=p.toLowerCase();return(p.substr(0,7)=="http://"||p.substr(0,8)=="https://"||p.substr(0,6)=="ftp://")};b.allowed_tags={b:1,blockquote:1,code:1,dd:1,dt:1,dl:1,del:1,em:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,i:1,kbd:1,li:1,ol:1,ul:1,p:1,pre:1,s:1,sub:1,sup:1,strong:1,strike:1,img:1,a:1};b.allowed_attributes={a:{href:1,title:1},img:{src:1,width:1,height:1,alt:1,title:1}};b.block_tags={p:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,blockquote:1,pre:1,table:1,dl:1,ol:1,ul:1,script:1,noscript:1,form:1,fieldset:1,iframe:1,math:1,ins:1,del:1};d=b.prototype;d.attributes=null;d.closed=false;d.closing=false;d.attributeCount=function(){if(!this.attributes){return 0}var s=0;for(var p in this.attributes){s++}return s};d.IsBlockTag=function(){return b.block_tags[this.name]==1};d.IsSafe=function(){var p=this.name.toLowerCase();if(!b.allowed_tags[p]){return false}var t=b.allowed_attributes[p];if(!t){return this.attributeCount()==0}if(!this.attributes){return true}for(var s in this.attributes){if(!t[s.toLowerCase()]){return false}}if(this.attributes.href){if(!b.IsSafeUrl(this.attributes.href)){return false}}if(this.attributes.src){if(!b.IsSafeUrl(this.attributes.src)){return false}}return true};b.Parse=function(u){var t=u.position;var s=this.ParseHelper(u);if(s!=null){return s}u.position=t;return null};b.ParseHelper=function(x){if(x.current()!="<"){return null}x.SkipForward(1);if(x.SkipString("!--")){x.Mark();if(x.Find("-->")){var v=new b("!");v.attributes.content=x.Extract();v.closed=true;x.SkipForward(3);return v}}var w=x.SkipChar("/");x.Mark();if(!x.SkipIdentifier()){return null}var s=new b(x.Extract());s.closing=w;if(w){if(x.current()!=">"){return null}x.SkipForward(1);return s}while(!x.eof()){x.SkipWhitespace();if(x.SkipString("/>")){s.closed=true;return s}if(x.SkipChar(">")){return s}x.Mark();if(!x.SkipIdentifier()){return null}var u=x.Extract();x.SkipWhitespace();if(!x.SkipChar("=")){return null}x.SkipWhitespace();if(x.SkipChar('"')){x.Mark();if(!x.Find('"')){return null}s.attributes[u]=x.Extract();x.SkipForward(1)}else{x.Mark();while(!x.eof()&&!f.is_whitespace(x.current())&&x.current()!=">"&&x.current()!="/"){x.SkipForward(1)}if(!x.eof()){s.attributes[u]=x.Extract()}}}return null};function o(t,p,s){this.id=t;this.url=p;if(s==undefined){this.title=null}else{this.title=s}}d=o.prototype;d.RenderLink=function(s,p,t){if(this.url.substr(0,7).toLowerCase()=="mailto:"){p.Append('<a href="');p.HtmlRandomize(this.url);p.Append('"');if(this.title){p.Append(' title="');p.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);p.Append('"')}p.Append(">");p.HtmlRandomize(t);p.Append("</a>")}else{p.Append('<a href="');p.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);p.Append('"');if(this.title){p.Append(' title="');p.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);p.Append('"')}p.Append(">");p.Append(t);p.Append("</a>")}};d.RenderImg=function(s,p,t){p.Append('<img src="');p.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);p.Append('"');if(t){p.Append(' alt="');p.SmartHtmlEncodeAmpsAndAngles(t,0,t.length);p.Append('"')}if(this.title){p.Append(' title="');p.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);p.Append('"')}p.Append(" />")};o.ParseLinkDefinition=function(u){var t=u.position;var s=o.ParseLinkDefinitionInternal(u);if(s==null){u.position=t}return s};o.ParseLinkDefinitionInternal=function(t){t.SkipWhitespace();if(!t.SkipChar("[")){return null}t.Mark();if(!t.Find("]")){return null}var u=t.Extract();if(u.length==0){return null}if(!t.SkipString("]:")){return null}var s=this.ParseLinkTarget(t,u);t.SkipLinespace();if(!t.eol()){return null}return s};o.ParseLinkTarget=function(x,w){x.SkipWhitespace();if(x.eol()){return null}var s=new o(w);if(x.SkipChar("<")){x.Mark();while(x.current()!=">"){if(x.eof()){return null}x.SkipEscapableChar()}var v=x.Extract();if(!x.SkipChar(">")){return null}s.url=g(l(v));x.SkipWhitespace()}else{x.Mark();var u=1;while(!x.eol()){var t=x.current();if(f.is_whitespace(t)){break}if(w==null){if(t=="("){u++}else{if(t==")"){u--;if(u==0){break}}}}x.SkipEscapableChar()}s.url=g(l(x.Extract()))}x.SkipLinespace();if(x.current()==")"){return s}var B=x.eol();var A=x.position;if(x.eol()){x.SkipEol();x.SkipLinespace()}var z;switch(x.current()){case"'":case'"':z=x.current();break;case"(":z=")";break;default:if(B){x.position=A;return s}else{return null}}x.SkipForward(1);x.Mark();while(true){if(x.eol()){return null}if(x.current()==z){if(z!=")"){var y=x.position;x.SkipForward(1);x.SkipLinespace();if((w==null&&x.current()!=")")||(w!=null&&!x.eol())){continue}x.position=y}break}x.SkipEscapableChar()}s.title=g(x.Extract());x.SkipForward(1);return s};function i(s,p){this.def=s;this.link_text=p}TokenType={};TokenType.Text=0;TokenType.HtmlTag=1;TokenType.Html=2;TokenType.open_em=3;TokenType.close_em=4;TokenType.open_strong=5;TokenType.close_strong=6;TokenType.code_span=7;TokenType.br=8;TokenType.link=9;TokenType.img=10;TokenType.opening_mark=11;TokenType.closing_mark=12;TokenType.internal_mark=13;function a(s,p,t){this.type=s;this.startOffset=p;this.length=t;this.data=null}function m(p){this.m_Markdown=p;this.m_Parser=new q();this.m_SpareTokens=new Array();this.DisableLinks=false}d=m.prototype;d.Format=function(s,v,w,p){this.m_Parser.reset(v,w,p);var u=this.Tokenize();if(u==null){s.HtmlEncode(v,w,p)}else{this.RenderTokens(s,v,u);for(var t=0;t<u.length;t++){this.FreeToken(u[t])}}};d.FormatDirect=function(s){var p=new r();this.Format(p,s,0,s.length);return p.ToString()};d.RenderTokens=function(z,y,x){var s=x.length;for(var v=0;v<s;v++){var u=x[v];switch(u.type){case TokenType.Text:z.HtmlEncode(y,u.startOffset,u.length);break;case TokenType.HtmlTag:z.SmartHtmlEncodeAmps(y,u.startOffset,u.length);break;case TokenType.Html:case TokenType.opening_mark:case TokenType.closing_mark:case TokenType.internal_mark:z.Append(y.substr(u.startOffset,u.length));break;case TokenType.br:z.Append("<br />\n");break;case TokenType.open_em:z.Append("<em>");break;case TokenType.close_em:z.Append("</em>");break;case TokenType.open_strong:z.Append("<strong>");break;case TokenType.close_strong:z.Append("</strong>");break;case TokenType.code_span:z.Append("<code>");z.HtmlEncode(y,u.startOffset,u.length);z.Append("</code>");break;case TokenType.link:var p=u.data;var w=new m(this.m_Markdown);w.DisableLinks=true;p.def.RenderLink(this.m_Markdown,z,w.FormatDirect(p.link_text));break;case TokenType.img:var p=u.data;p.def.RenderImg(this.m_Markdown,z,p.link_text);break}}};d.Tokenize=function(){var t=this.m_Parser;var y=null;var s=null;var z=t.position;while(!t.eof()){var w=t.position;var v=null;switch(t.current()){case"*":case"_":v=this.CreateEmphasisMark();switch(v.type){case TokenType.internal_mark:case TokenType.opening_mark:case TokenType.closing_mark:if(s==null){s=new Array()}s.push(v);break}break;case"`":v=this.ProcessCodeSpan();break;case"[":case"!":var u=t.position;v=this.ProcessLinkOrImage();if(v==null){t.position=u}break;case"<":var x=t.position;var A=b.Parse(t);if(A!=null){v=this.CreateToken(TokenType.HtmlTag,x,t.position-x)}else{t.position=x;v=this.ProcessAutoLink();if(v==null){t.position=x}}break;case"&":var x=t.position;if(t.SkipHtmlEntity()){v=this.CreateToken(TokenType.Html,x,t.position-x)}break;case" ":if(t.CharAtOffset(1)==" "&&f.is_lineend(t.CharAtOffset(2))){t.SkipForward(2);if(!t.eof()){t.SkipEol();v=this.CreateToken(TokenType.br,w,0)}}break;case"\\":if(f.is_escapable(t.CharAtOffset(1))){v=this.CreateToken(TokenType.Text,t.position+1,1);t.SkipForward(2)}break}if(v!=null){if(y==null){y=new Array()}if(w>z){y.push(this.CreateToken(TokenType.Text,z,w-z))}y.push(v);z=t.position}else{t.SkipForward(1)}}if(y==null){return null}if(t.position>z){y.push(this.CreateToken(TokenType.Text,z,t.position-z))}if(s!=null){this.ResolveEmphasisMarks(y,s)}return y};d.CreateEmphasisMark=function(){var y=this.m_Parser;var u=y.current();var x=u=="*"?"_":"*";var w=y.position;if(y.bof()||f.is_whitespace(y.CharAtOffset(-1))){while(f.is_emphasis(y.current())){y.SkipForward(1)}if(y.eof()||f.is_whitespace(y.current())){return this.CreateToken(TokenType.Html,w,y.position-w)}y.position=w}while(f.is_emphasis(y.CharAtOffset(-1))){y.SkipForward(-1)}var s=y.bof()||f.is_whitespace(y.CharAtOffset(-1));y.position=w;while(y.current()==u){y.SkipForward(1)}var v=y.position-w;while(f.is_emphasis(y.CharAtOffset(1))){y.SkipForward(1)}var t=y.eof()||f.is_whitespace(y.CharAtOffset(1));y.position=w+v;if(s){return this.CreateToken(TokenType.opening_mark,w,y.position-w)}if(t){return this.CreateToken(TokenType.closing_mark,w,y.position-w)}return this.CreateToken(TokenType.internal_mark,w,y.position-w)};d.SplitMarkToken=function(v,t,s,p){var u=this.CreateToken(s.type,s.startOffset+p,s.length-p);s.length=p;t.splice(t.indexOf(s)+1,0,u);v.splice(v.indexOf(s)+1,0,u);return u};d.ResolveEmphasisMarks=function(w,y){var z=this.m_Parser.buf;var x=true;while(x){x=false;for(var u=0;u<y.length;u++){var v=y[u];if(v.type!=TokenType.opening_mark&&v.type!=TokenType.internal_mark){continue}for(var t=u+1;t<y.length;t++){var s=y[t];if(s.type!=TokenType.closing_mark&&s.type!=TokenType.internal_mark){break}if(z.charAt(v.startOffset)!=z.charAt(s.startOffset)){continue}var p=Math.min(v.length,s.length);if(p>=3){p=(p%2)==1?1:2}if(v.length>p){v=this.SplitMarkToken(w,y,v,v.length-p);u--}if(s.length>p){this.SplitMarkToken(w,y,s,p)}v.type=p==1?TokenType.open_em:TokenType.open_strong;s.type=p==1?TokenType.close_em:TokenType.close_strong;y.splice(y.indexOf(v),1);y.splice(y.indexOf(s),1);x=true;break}}}};d.ProcessAutoLink=function(){if(this.DisableLinks){return null}var w=this.m_Parser;w.SkipForward(1);w.Mark();while(!w.eof()){var v=w.current();if(f.is_whitespace(v)){break}if(v==">"){var u=g(w.Extract());var s=null;if(j(u)){var t;if(u.toLowerCase().substr(0,7)=="mailto:"){t=u.substr(7)}else{t=u;u="mailto:"+u}s=new i(new o("auto",u,null),t)}else{if(n(u)){s=new i(new o("auto",u,null),u)}}if(s!=null){w.SkipForward(1);return this.CreateDataToken(TokenType.link,s)}return null}w.SkipEscapableChar()}return null};d.ProcessLinkOrImage=function(){if(this.DisableLinks){return null}var v=this.m_Parser;var D=v.SkipChar("!")?TokenType.img:TokenType.link;if(!v.SkipChar("[")){return null}v.Mark();var C=1;while(!v.eof()){var s=v.current();if(s=="["){C++}else{if(s=="]"){C--;if(C==0){break}}}v.SkipEscapableChar()}if(v.eof()){return null}var t=g(v.Extract());v.SkipForward(1);var x=v.position;if(v.SkipChar("(")){var A=o.ParseLinkTarget(v,null);if(A==null){return null}v.SkipWhitespace();if(!v.SkipChar(")")){return null}return this.CreateDataToken(D,new i(A,t))}if(!v.SkipChar(" ")){v.SkipChar("\t")}if(v.eol()){v.SkipEol();v.SkipLinespace()}var y=null;if(v.current()=="["){v.SkipForward(1);v.Mark();if(!v.Find("]")){return null}y=v.Extract();v.SkipForward(1)}else{v.position=x}if(!y){y=t;while(true){var B=y.indexOf("\n");if(B<0){break}var u=B;while(u>0&&f.is_whitespace(y.charAt(u-1))){u--}var z=B;while(z<y.length&&f.is_whitespace(y.charAt(z))){z++}y=y.substr(0,u)+" "+y.substr(z)}}var w=this.m_Markdown.GetLinkDefinition(y);if(w==null){return null}return this.CreateDataToken(D,new i(w,t))};d.ProcessCodeSpan=function(){var w=this.m_Parser;var x=w.position;var u=0;while(w.SkipChar("`")){u++}w.SkipWhitespace();if(w.eof()){return this.CreateToken(TokenType.Text,x,w.position-x)}var t=w.position;if(!w.Find(w.buf.substr(x,u))){return this.CreateToken(TokenType.Text,x,w.position-x)}var v=w.position+u;while(f.is_whitespace(w.CharAtOffset(-1))){w.SkipForward(-1)}var s=this.CreateToken(TokenType.code_span,t,w.position-t);w.position=v;return s};d.CreateToken=function(u,p,v){if(this.m_SpareTokens.length!=0){var s=this.m_SpareTokens.pop();s.type=u;s.startOffset=p;s.length=v;s.data=null;return s}else{return new a(u,p,v)}};d.CreateDataToken=function(s,u){if(this.m_SpareTokens.length!=0){var p=this.m_SpareTokens.pop();p.type=s;p.data=u;return p}else{var p=new a(s,0,0);p.data=u;return p}};d.FreeToken=function(p){p.data=null;this.m_SpareTokens.push(p)};BlockType={};BlockType.Blank=0;BlockType.h1=1;BlockType.h2=2;BlockType.h3=3;BlockType.h4=4;BlockType.h5=5;BlockType.h6=6;BlockType.post_h1=7;BlockType.post_h2=8;BlockType.quote=9;BlockType.ol_li=10;BlockType.ul_li=11;BlockType.p=12;BlockType.indent=13;BlockType.hr=14;BlockType.html=15,BlockType.span=16;BlockType.codeblock=17;BlockType.li=18;BlockType.ol=19;BlockType.ul=20;function c(){}d=c.prototype;d.buf=null;d.blockType=BlockType.Blank;d.contentStart=0;d.contentLen=0;d.lineStart=0;d.lineLen=0;d.children=null;d.get_Content=function(){if(this.buf==null){return null}if(this.contentStart==-1){return this.buf}return this.buf.substr(this.contentStart,this.contentLen)};d.get_CodeContent=function(){var t=new r();for(var p=0;p<this.children.length;p++){t.Append(this.children[p].get_Content());t.Append("\n")}return t.ToString()};d.RenderChildren=function(s,p){for(var t=0;t<this.children.length;t++){this.children[t].Render(s,p)}};d.Render=function(s,p){switch(this.blockType){case BlockType.Blank:return;case BlockType.p:p.Append("<p>");s.processSpan(p,this.buf,this.contentStart,this.contentLen);p.Append("</p>\n");break;case BlockType.span:s.processSpan(p,this.buf,this.contentStart,this.contentLen);p.Append("\n");break;case BlockType.h1:case BlockType.h2:case BlockType.h3:case BlockType.h4:case BlockType.h5:case BlockType.h6:p.Append("<h"+(this.blockType-BlockType.h1+1).toString()+">");s.processSpan(p,this.buf,this.contentStart,this.contentLen);p.Append("</h"+(this.blockType-BlockType.h1+1).toString()+">\n");break;case BlockType.hr:p.Append("<hr />\n");return;case BlockType.ol_li:case BlockType.ul_li:p.Append("<li>");s.processSpan(p,this.buf,this.contentStart,this.contentLen);p.Append("</li>\n");break;case BlockType.html:p.Append(this.buf.substr(this.contentStart,this.contentLen));return;case BlockType.codeblock:p.Append("<pre><code>");for(var u=0;u<this.children.length;u++){var t=this.children[u];p.HtmlEncodeAndConvertTabsToSpaces(t.buf,t.contentStart,t.contentLen);p.Append("\n")}p.Append("</code></pre>\n\n");return;case BlockType.quote:p.Append("<blockquote>\n");this.RenderChildren(s,p);p.Append("</blockquote>\n");return;case BlockType.li:p.Append("<li>\n");this.RenderChildren(s,p);p.Append("</li>\n");return;case BlockType.ol:p.Append("<ol>\n");this.RenderChildren(s,p);p.Append("</ol>\n");return;case BlockType.ul:p.Append("<ul>\n");this.RenderChildren(s,p);p.Append("</ul>\n");return}};d.RevertToPlain=function(){this.blockType=BlockType.p;this.contentStart=this.lineStart;this.contentLen=this.lineLen};d.get_contentEnd=function(){return this.contentStart+this.contentLen};d.set_contentEnd=function(p){this.contentLen=p-this.contentStart};d.get_leadingSpaces=function(){var s=0;for(var p=this.lineStart;p<this.lineStart+this.lineLen;p++){if(this.buf.charAt(p)==" "){s++}else{break}}return s};d.CopyFrom=function(p){this.blockType=p.blockType;this.buf=p.buf;this.contentStart=p.contentStart;this.contentLen=p.contentLen;this.lineStart=p.lineStart;this.lineLen=p.lineLen;return this};function e(p){this.m_Markdown=p;this.m_parentType=BlockType.Blank}d=e.prototype;d.Process=function(x){var v=new q(x);var w=new Array();var t=new Array();while(!v.eof()){var s=this.EvaluateLine(v);if(s.blockType==BlockType.post_h1||s.blockType==BlockType.post_h2){if(t.length>0){var y=t.pop();this.CollapseLines(w,t);if(y.blockType!=BlockType.Blank){y.RevertToPlain();y.blockType=s.blockType==BlockType.post_h1?BlockType.h1:BlockType.h2;w.push(y);continue}}if(s.blockType==BlockType.post_h1){s.RevertToPlain();t.push(s)}else{if(s.contentLen>=3){s.blockType=BlockType.hr;w.push(s)}else{s.RevertToPlain();t.push(s)}}continue}var u=t.length>0?t[0].blockType:BlockType.Blank;switch(s.blockType){case BlockType.Blank:switch(u){case BlockType.Blank:this.FreeBlock(s);break;case BlockType.p:this.CollapseLines(w,t);this.FreeBlock(s);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:t.push(s);break}break;case BlockType.p:switch(u){case BlockType.Blank:case BlockType.p:t.push(s);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:var y=t[t.length-1];if(y.blockType==BlockType.Blank){this.CollapseLines(w,t);t.push(s)}else{t.push(s)}break;case BlockType.indent:this.CollapseLines(w,t);t.push(s);break}break;case BlockType.indent:switch(u){case BlockType.Blank:t.push(s);break;case BlockType.p:case BlockType.quote:var y=t[t.length-1];if(y.blockType==BlockType.Blank){this.CollapseLines(w,t);t.push(s)}else{s.RevertToPlain();t.push(s)}break;case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:t.push(s);break}break;case BlockType.quote:if(u!=BlockType.quote){this.CollapseLines(w,t)}t.push(s);break;case BlockType.ol_li:case BlockType.ul_li:switch(u){case BlockType.Blank:t.push(s);break;case BlockType.p:case BlockType.quote:var y=t[t.length-1];if(y.blockType==BlockType.Blank||this.m_parentType==BlockType.ol_li||this.m_parentType==BlockType.ul_li){this.CollapseLines(w,t);t.push(s)}else{s.RevertToPlain();t.push(s)}break;case BlockType.ol_li:case BlockType.ul_li:if(s.blockType!=u){this.CollapseLines(w,t)}t.push(s);break;case BlockType.indent:this.CollapseLines(w,t);t.push(s);break}break;case BlockType.h1:case BlockType.h2:case BlockType.h3:case BlockType.h4:case BlockType.h5:case BlockType.h6:case BlockType.html:case BlockType.hr:this.CollapseLines(w,t);w.push(s);break}}this.CollapseLines(w,t);return w};d.CreateBlock=function(){if(this.m_Markdown.m_SpareBlocks.length>1){return this.m_Markdown.m_SpareBlocks.pop()}else{return new c()}};d.FreeBlock=function(p){this.m_Markdown.m_SpareBlocks.push(p)};d.FreeBlocks=function(s){for(var p=0;p<s.length;p++){this.m_Markdown.m_SpareBlocks.push(s[p])}s.length=0};d.RenderLines=function(t){var p=this.m_Markdown.GetStringBuilder();for(var u=0;u<t.length;u++){var s=t[u];p.Append(s.buf.substr(s.contentStart,s.contentLen));p.Append("\n")}return p.ToString()};d.CollapseLines=function(y,s){while(s.length>0&&s[s.length-1].blockType==BlockType.Blank){this.FreeBlock(s.pop())}if(s.length==0){return}switch(s[0].blockType){case BlockType.p:var p=this.CreateBlock();p.blockType=BlockType.p;p.buf=s[0].buf;p.contentStart=s[0].contentStart;p.set_contentEnd(s[s.length-1].get_contentEnd());y.push(p);this.FreeBlocks(s);break;case BlockType.quote:var x=this.RenderLines(s);var w=new e(this.m_Markdown);w.m_parentType=BlockType.quote;var t=this.CreateBlock();t.blockType=BlockType.quote;t.children=w.Process(x);this.FreeBlocks(s);y.push(t);break;case BlockType.ol_li:case BlockType.ul_li:y.push(this.BuildList(s));break;case BlockType.indent:var v=this.CreateBlock();v.blockType=BlockType.codeblock;v.children=new Array();for(var u=0;u<s.length;u++){v.children.push(s[u])}y.push(v);s.length=0;break}};d.EvaluateLine=function(t){var s=this.CreateBlock();s.lineStart=t.position;s.buf=t.buf;s.contentStart=t.position;s.contentLen=-1;s.blockType=this.EvaluateLineInternal(t,s);t.SkipToEol();if(s.contentLen<0){s.contentLen=t.position-s.contentStart}s.lineLen=t.position-s.lineStart;t.SkipEol();return s};d.EvaluateLineInternal=function(u,B){if(u.eol()){return BlockType.Blank}var w=u.position;var s=u.current();if(s=="#"){var t=1;u.SkipForward(1);while(u.current()=="#"){t++;u.SkipForward(1)}if(t>6){t=6}u.SkipWhitespace();B.contentStart=u.position;u.SkipToEol();while(u.CharAtOffset(-1)=="#"){u.SkipForward(-1)}while(f.is_whitespace(u.CharAtOffset(-1))){u.SkipForward(-1)}B.contentLen=u.position-B.contentStart;u.SkipToEol();return BlockType.h1+(t-1)}if(s=="-"||s=="="){var z=s;while(u.current()==z){u.SkipForward(1)}u.SkipLinespace();if(u.eol()){return z=="="?BlockType.post_h1:BlockType.post_h2}u.position=w}var y=-1;var v=0;while(!u.eol()){if(u.current()==" "){if(y<0){v++}}else{if(u.current()=="\t"){if(y<0){y=u.position}}else{break}}u.SkipForward(1)}if(u.eol()){B.contentLen=0;return BlockType.Blank}if(v>=4){B.contentStart=w+4;return BlockType.indent}if(y>=0&&y-w<4){B.contentStart=y+1;return BlockType.indent}B.contentStart=u.position;s=u.current();if(s=="<"){if(this.ScanHtml(u)){B.contentLen=u.position-B.contentStart;return BlockType.html}u.position=B.contentStart}if(s==">"){if(f.is_linespace(u.CharAtOffset(1))){u.SkipForward(2);B.contentStart=u.position;return BlockType.quote}u.SkipForward(1);B.contentStart=u.position;return BlockType.quote}if(s=="-"||s=="_"||s=="*"){var A=0;while(!u.eol()){var z=u.current();if(u.current()==s){A++;u.SkipForward(1);continue}if(f.is_linespace(u.current())){u.SkipForward(1);continue}break}if(u.eol()&&A>=3){return BlockType.hr}u.position=B.contentStart}if((s=="*"||s=="+"||s=="-")&&f.is_linespace(u.CharAtOffset(1))){u.SkipForward(1);u.SkipLinespace();B.contentStart=u.position;return BlockType.ul_li}if(f.is_digit(s)){u.SkipForward(1);while(f.is_digit(u.current())){u.SkipForward(1)}if(u.SkipChar(".")&&u.SkipLinespace()){B.contentStart=u.position;return BlockType.ol_li}u.position=B.contentStart}if(s=="["){var x=o.ParseLinkDefinition(u);if(x!=null){this.m_Markdown.AddLinkDefinition(x);return BlockType.Blank}}return BlockType.p};d.ScanHtml=function(u){var t=b.Parse(u);if(t==null){return false}if(t.closing){return false}if(t.name=="!"||t.name.toLowerCase()=="hr"||t.closed){u.SkipLinespace();u.SkipEol();return true}if(!t.IsBlockTag()){return false}var v=1;while(!u.eof()){if(u.current()!="<"){u.SkipForward(1);continue}var s=b.Parse(u);if(s==null){u.SkipForward(1);continue}if(s.name==t.name&&!s.closed){if(s.closing){v--;if(v==0){u.SkipLinespace();u.SkipEol();return true}}else{v++}}}return false};d.BuildList=function(F){var C=F[0].blockType;var z=F[0].leadingSpaces;for(var v=1;v<F.length;v++){if((F[v].blockType==BlockType.p)&&(F[v-1].blockType==BlockType.p||F[v-1].blockType==C)){F[v-1].set_contentEnd(F[v].get_contentEnd());this.FreeBlock(F[v]);F.splice(v,1);v--;continue}if(F[v].blockType!=BlockType.indent&&F[v].blockType!=BlockType.Blank){var G=F[v].leadingSpaces;if(G>z){F[v].blockType=BlockType.indent;var B=F[v].get_contentEnd();F[v].contentStart=F[v].lineStart+G;F[v].set_contentEnd(B)}}}var E=this.CreateBlock();E.blockType=(C==BlockType.ul_li?BlockType.ul:BlockType.ol);E.children=new Array();for(var v=0;v<F.length;v++){var w=v;while(w>0&&F[w-1].blockType==BlockType.Blank){w--}var y=v;while(y<F.length-1&&F[y+1].blockType!=C){y++}if(w==y){E.children.push(this.CreateBlock().CopyFrom(F[v]))}else{var x=false;var A=this.m_Markdown.GetStringBuilder();for(var u=w;u<=y;u++){var t=F[u];A.Append(t.buf.substr(t.contentStart,t.contentLen));A.Append("\n");if(F[u].blockType==BlockType.Blank){x=true}}var D=this.CreateBlock();D.blockType=BlockType.li;var p=new e(this.m_Markdown);p.m_parentType=C;D.children=p.Process(A.ToString());if(!x){for(var v=0;v<D.children.length;v++){var s=D.children[v];if(s.blockType==BlockType.p){s.blockType=BlockType.span}}}E.children.push(D)}v=y}this.FreeBlocks(F);F.length=0;return E};this.Markdown=k;this.StringBuilder=r;this.SpanFormatter=m;this.StringParser=q;this.BlockProcessor=e;this.LinkDefinition=o;this.HtmlTag=b;this.UnescapeString=g;this.BlockType=BlockType}();