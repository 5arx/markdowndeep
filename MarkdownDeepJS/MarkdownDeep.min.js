if(Array.prototype.indexOf==undefined){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]===b){return a}}return -1}}var MarkdownDeep=new function(){function s(){this.m_SpanFormatter=new k(this);this.m_SpareBlocks=new Array();this.m_StringBuilder=new j();this.m_LinkDefinitions=new Array()}var q=s.prototype;q.Transform=function(p){var A=p.indexOf("\r");if(A>=0){var C=p.indexOf("\n");if(C>=0){if(C<A){p=p.replace(/\n\r/g,"\n")}else{p=p.replace(/\r\n/g,"\n")}}p=p.replace(/\r/g,"\n")}this.m_LinkDefinitions.length=0;var z=new h(this).Process(p);var B=this.GetStringBuilder();for(var y=0;y<z.length;y++){var n=z[y];n.Render(this,B)}return B.ToString()};q.AddLinkDefinition=function(b){this.m_LinkDefinitions[b.id]=b};q.GetLinkDefinition=function(i){var b=this.m_LinkDefinitions[i];if(b==undefined){return null}else{return b}};q.GetStringBuilder=function(){this.m_StringBuilder.Clear();return this.m_StringBuilder};q.processSpan=function(p,i,n,b){return this.m_SpanFormatter.Format(p,i,n,b)};var c={};c.is_digit=function(b){return b>="0"&&b<="9"};c.is_hex=function(b){return(b>="0"&&b<="9")||(b>="a"&&b<="f")||(b>="A"&&b<="F")};c.is_alpha=function(b){return(b>="a"&&b<="z")||(b>="A"&&b<="Z")};c.is_alphadigit=function(b){return(b>="a"&&b<="z")||(b>="A"&&b<="Z")||(b>="0"&&b<="9")};c.is_whitespace=function(b){return(b==" "||b=="\t"||b=="\r"||b=="\n")};c.is_linespace=function(b){return(b==" "||b=="\t")};c.is_lineend=function(b){return(b=="\r"||b=="\n")};c.is_emphasis=function(b){return(b=="*"||b=="_")};c.is_escapable=function(b){switch(b){case"\\":case"`":case"*":case"_":case"{":case"}":case"[":case"]":case"(":case")":case"#":case"+":case"-":case".":case"!":case">":return true}return false};function v(i,n){if(i.charAt(n)!="&"){return -1}var b=n;n++;if(i.charAt(n)=="#"){n++;if(i.charAt(n)=="x"||i.charAt(n)=="X"){n++;fn_test=c.is_hex}else{fn_test=c.is_digit}}else{fn_test=c.is_alphadigit}if(fn_test(i.charAt(n))){n++;while(fn_test(i.charAt(n))){n++}if(i.charAt(n)==";"){n++;return n}}n=b;return -1}function o(y){var n=y.indexOf("\\");if(n<0){return y}var i=new j();var p=0;while(n>=0){if(c.is_escapable(y.charAt(n+1))){if(n>p){i.Append(y.substr(p,n-p))}p=n+1}n=y.indexOf("\\",n+1)}if(p<y.length){i.Append(y.substr(p,y.length-p))}return i.ToString()}function x(p){var n=0;var b=p.length;while(n<b&&c.is_whitespace(p.charAt(n))){n++}while(b-1>n&&c.is_whitespace(p.charAt(n-1))){n--}return p.substr(n,b-n)}function g(n){var b=n.indexOf("@");if(b<0){return false}var i=n.lastIndexOf(".");if(i<b){return false}return true}function a(b){b=b.toLowerCase();if(b.substr(0,7)=="http://"){return true}if(b.substr(0,8)=="https://"){return true}if(b.substr(0,6)=="ftp://"){return true}if(b.substr(0,7)=="file://"){return true}return false}function j(){this.content=new Array()}q=j.prototype;q.Append=function(b){if(b){this.content.push(b)}};q.Clear=function(){this.content.length=0};q.ToString=function(){return this.content.join("")};q.HtmlRandomize=function(p){var n=p.length;for(var y=0;y<n;y++){var b=Math.random();if(b>0.9&&p.charAt(y)!="@"){this.Append(p.charAt(y))}else{if(b>0.45){this.Append("&#");this.Append(p.charCodeAt(y).toString());this.Append(";")}else{this.Append("&#x");this.Append(p.charCodeAt(y).toString(16));this.Append(";")}}}};q.HtmlEncode=function(A,b,z){var n=b+z;var y=b;for(var p=b;p<n;p++){switch(A.charAt(p)){case"&":if(p>y){this.Append(A.substr(y,p-y))}this.Append("&amp;");y=p+1;break;case"<":if(p>y){this.Append(A.substr(y,p-y))}this.Append("&lt;");y=p+1;break;case">":if(p>y){this.Append(A.substr(y,p-y))}this.Append("&gt;");y=p+1;break;case'"':if(p>y){this.Append(A.substr(y,p-y))}this.Append("&quot;");y=p+1;break}}if(p>y){this.Append(A.substr(y,p-y))}};q.SmartHtmlEncodeAmpsAndAngles=function(B,b,z){var n=b+z;var y=b;for(var p=b;p<n;p++){switch(B.charAt(p)){case"&":var A=v(B,p);if(A<0){if(p>y){this.Append(B.substr(y,p-y))}this.Append("&amp;");y=p+1}else{p=A-1}break;case"<":if(p>y){this.Append(B.substr(y,p-y))}this.Append("&lt;");y=p+1;break;case">":if(p>y){this.Append(B.substr(y,p-y))}this.Append("&gt;");y=p+1;break;case'"':if(p>y){this.Append(B.substr(y,p-y))}this.Append("&quot;");y=p+1;break}}if(p>y){this.Append(B.substr(y,p-y))}};q.SmartHtmlEncodeAmps=function(B,b,z){var n=b+z;var y=b;for(var p=b;p<n;p++){switch(B.charAt(p)){case"&":var A=v(B,p);if(A<0){if(p>y){this.Append(B.substr(y,p-y))}this.Append("&amp;");y=p+1}else{p=A-1}break}}if(p>y){this.Append(B.substr(y,p-y))}};q.HtmlEncodeAndConvertTabsToSpaces=function(A,b,z){var n=b+z;var y=b;var B=0;for(var p=b;p<n;p++){switch(A.charAt(p)){case"\t":if(p>y){this.Append(A.substr(y,p-y))}y=p+1;this.Append(" ");B++;while((B%4)!=0){this.Append(" ");B++}B--;break;case"&":if(p>y){this.Append(A.substr(y,p-y))}this.Append("&amp;");y=p+1;break;case"<":if(p>y){this.Append(A.substr(y,p-y))}this.Append("&lt;");y=p+1;break;case">":if(p>y){this.Append(A.substr(y,p-y))}this.Append("&gt;");y=p+1;break;case'"':if(p>y){this.Append(A.substr(y,p-y))}this.Append("&quot;");y=p+1;break}B++}if(p>y){this.Append(A.substr(y,p-y))}};function l(){this.reset.apply(this,arguments)}q=l.prototype;q.bof=function(){return this.position==this.start};q.eof=function(){return this.position>=this.end};q.eol=function(){var b=this.buf.charAt(this.position);return b=="\r"||b=="\n"||b==undefined||b==""};q.reset=function(){this.buf=arguments.length>0?arguments[0]:null;this.start=arguments.length>1?arguments[1]:0;this.end=arguments.length>2?this.start+arguments[2]:(this.buf==null?0:this.buf.length);this.position=this.start};q.current=function(){if(this.position>=this.end){return"\0"}return this.buf.charAt(this.position)};q.remainder=function(){return this.buf.substr(this.position)};q.SkipToEof=function(){this.position=this.end};q.SkipForward=function(b){this.position+=b};q.SkipToEol=function(){this.position=this.buf.indexOf("\n",this.position);if(this.position<0){this.position=this.end}};q.SkipEol=function(){var b=this.position;if(this.buf.charAt(this.position)=="\r"){this.position++}if(this.buf.charAt(this.position)=="\n"){this.position++}return this.position!=b};q.SkipToNextLine=function(){this.SkipToEol();this.SkipEol()};q.CharAtOffset=function(b){if(this.position+b>=this.end){return"\0"}return this.buf.charAt(this.position+b)};q.SkipChar=function(b){if(this.buf.charAt(this.position)==b){this.position++;return true}return false};q.SkipString=function(b){if(this.buf.substr(this.position,b.length)==b){this.position+=b.length;return true}return false};q.SkipWhitespace=function(){var i=this.position;while(true){var b=this.buf.charAt(this.position);if(b!=" "&&b!="\t"&&b!="\r"&&b!="\n"){break}this.position++}return this.position!=i};q.SkipLinespace=function(){var i=this.position;while(true){var b=this.buf.charAt(this.position);if(b!=" "&&b!="\t"){break}this.position++}return this.position!=i};q.Find=function(b){this.position=this.buf.indexOf(b,this.position);if(this.position<0){this.position=this.end;return false}return true};q.Mark=function(){this.mark=this.position};q.Extract=function(){if(this.mark>=this.position){return""}else{return this.buf.substr(this.mark,this.position-this.mark)}};q.SkipIdentifier=function(){var b=this.buf.charAt(this.position);if((b>="a"&&b<="z")||(b>="A"&&b<="Z")||b=="_"){this.position++;while(true){var b=this.buf.charAt(this.position);if((b>="a"&&b<="z")||(b>="A"&&b<="Z")||b=="_"||(b>="0"&&b<="9")){this.position++}else{return true}}}return false};q.SkipHtmlEntity=function(){if(this.buf.charAt(this.position)!="&"){return false}var b=v(this.buf,this.position);if(b<0){return false}this.position=b;return true};q.SkipEscapableChar=function(){if(this.buf.charAt(this.position)=="\\"&&c.is_escapable(this.buf.charAt(this.position+1))){this.position+=2;return true}else{if(this.position<this.end){this.position++}return false}};HtmlTagFlags={};HtmlTagFlags.Block=1;HtmlTagFlags.Inline=2;HtmlTagFlags.NoClosing=4;function d(b){this.name=b;this.attributes={};this.flags=0}q=d.prototype;q.attributes=null;q.closed=false;q.closing=false;q.attributeCount=function(){if(!this.attributes){return 0}var i=0;for(var b in this.attributes){i++}return i};q.get_Flags=function(){if(this.flags==0){this.flags=tag_flags[this.name.toLowerCase()];if(this.flags==undefined){this.flags=HtmlTagFlags.Inline}}return this.flags};q.IsSafe=function(){var b=this.name.toLowerCase();if(!allowed_tags[b]){return false}var p=allowed_attributes[b];if(!p){return this.attributeCount()==0}if(!this.attributes){return true}for(var n in this.attributes){if(!p[n.toLowerCase()]){return false}}if(this.attributes.href){if(!d.IsSafeUrl(this.attributes.href)){return false}}if(this.attributes.src){if(!d.IsSafeUrl(this.attributes.src)){return false}}return true};d.IsSafeUrl=function(b){b=b.toLowerCase();return(b.substr(0,7)=="http://"||b.substr(0,8)=="https://"||b.substr(0,6)=="ftp://")};d.Parse=function(n){var i=n.position;var b=this.ParseHelper(n);if(b!=null){return b}n.position=i;return null};d.ParseHelper=function(z){if(z.current()!="<"){return null}z.SkipForward(1);if(z.SkipString("!--")){z.Mark();if(z.Find("-->")){var n=new d("!");n.attributes.content=z.Extract();n.closed=true;z.SkipForward(3);return n}}var y=z.SkipChar("/");z.Mark();if(!z.SkipIdentifier()){return null}var b=new d(z.Extract());b.closing=y;if(y){if(z.current()!=">"){return null}z.SkipForward(1);return b}while(!z.eof()){z.SkipWhitespace();if(z.SkipString("/>")){b.closed=true;return b}if(z.SkipChar(">")){return b}z.Mark();if(!z.SkipIdentifier()){return null}var i=z.Extract();z.SkipWhitespace();if(!z.SkipChar("=")){return null}z.SkipWhitespace();if(z.SkipChar('"')){z.Mark();if(!z.Find('"')){return null}b.attributes[i]=z.Extract();z.SkipForward(1)}else{z.Mark();while(!z.eof()&&!c.is_whitespace(z.current())&&z.current()!=">"&&z.current()!="/"){z.SkipForward(1)}if(!z.eof()){b.attributes[i]=z.Extract()}}}return null};allowed_tags={b:1,blockquote:1,code:1,dd:1,dt:1,dl:1,del:1,em:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,i:1,kbd:1,li:1,ol:1,ul:1,p:1,pre:1,s:1,sub:1,sup:1,strong:1,strike:1,img:1,a:1};allowed_attributes={a:{href:1,title:1},img:{src:1,width:1,height:1,alt:1,title:1}};var w=HtmlTagFlags.Block;var u=HtmlTagFlags.Inline;var t=HtmlTagFlags.NoClosing;tag_flags={p:w,div:w,h1:w,h2:w,h3:w,h4:w,h5:w,h6:w,blockquote:w,pre:w,table:w,dl:w,ol:w,ul:w,script:w,noscript:w,form:w,fieldset:w,iframe:w,math:w,ins:w|u,del:w|u,img:w|u,hr:w|t,"!":w|t};delete w;delete u;delete t;function f(n,b,i){this.id=n;this.url=b;if(i==undefined){this.title=null}else{this.title=i}}q=f.prototype;q.RenderLink=function(n,i,p){if(this.url.substr(0,7).toLowerCase()=="mailto:"){i.Append('<a href="');i.HtmlRandomize(this.url);i.Append('"');if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(">");i.HtmlRandomize(p);i.Append("</a>")}else{i.Append('<a href="');i.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);i.Append('"');if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(">");i.Append(p);i.Append("</a>")}};q.RenderImg=function(n,i,p){i.Append('<img src="');i.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);i.Append('"');if(p){i.Append(' alt="');i.SmartHtmlEncodeAmpsAndAngles(p,0,p.length);i.Append('"')}if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(" />")};f.ParseLinkDefinition=function(n){var i=n.position;var b=f.ParseLinkDefinitionInternal(n);if(b==null){n.position=i}return b};f.ParseLinkDefinitionInternal=function(i){i.SkipWhitespace();if(!i.SkipChar("[")){return null}i.Mark();if(!i.Find("]")){return null}var n=i.Extract();if(n.length==0){return null}if(!i.SkipString("]:")){return null}var b=this.ParseLinkTarget(i,n);i.SkipLinespace();if(!i.eol()){return null}return b};f.ParseLinkTarget=function(A,z){A.SkipWhitespace();if(A.eol()){return null}var b=new f(z);if(A.SkipChar("<")){A.Mark();while(A.current()!=">"){if(A.eof()){return null}A.SkipEscapableChar()}var y=A.Extract();if(!A.SkipChar(">")){return null}b.url=o(x(y));A.SkipWhitespace()}else{A.Mark();var n=1;while(!A.eol()){var i=A.current();if(c.is_whitespace(i)){break}if(z==null){if(i=="("){n++}else{if(i==")"){n--;if(n==0){break}}}}A.SkipEscapableChar()}b.url=o(x(A.Extract()))}A.SkipLinespace();if(A.current()==")"){return b}var E=A.eol();var D=A.position;if(A.eol()){A.SkipEol();A.SkipLinespace()}var C;switch(A.current()){case"'":case'"':C=A.current();break;case"(":C=")";break;default:if(E){A.position=D;return b}else{return null}}A.SkipForward(1);A.Mark();while(true){if(A.eol()){return null}if(A.current()==C){if(C!=")"){var B=A.position;A.SkipForward(1);A.SkipLinespace();if((z==null&&A.current()!=")")||(z!=null&&!A.eol())){continue}A.position=B}break}A.SkipEscapableChar()}b.title=o(A.Extract());A.SkipForward(1);return b};function e(i,b){this.def=i;this.link_text=b}TokenType={};TokenType.Text=0;TokenType.HtmlTag=1;TokenType.Html=2;TokenType.open_em=3;TokenType.close_em=4;TokenType.open_strong=5;TokenType.close_strong=6;TokenType.code_span=7;TokenType.br=8;TokenType.link=9;TokenType.img=10;TokenType.opening_mark=11;TokenType.closing_mark=12;TokenType.internal_mark=13;function m(i,b,n){this.type=i;this.startOffset=b;this.length=n;this.data=null}function k(b){this.m_Markdown=b;this.m_Parser=new l();this.m_SpareTokens=new Array();this.DisableLinks=false}q=k.prototype;q.Format=function(n,z,A,b){this.m_Parser.reset(z,A,b);var y=this.Tokenize();if(y==null){n.HtmlEncode(z,A,b)}else{this.RenderTokens(n,z,y);for(var p=0;p<y.length;p++){this.FreeToken(y[p])}}};q.FormatDirect=function(i){var b=new j();this.Format(b,i,0,i.length);return b.ToString()};q.RenderTokens=function(C,B,A){var n=A.length;for(var y=0;y<n;y++){var p=A[y];switch(p.type){case TokenType.Text:C.HtmlEncode(B,p.startOffset,p.length);break;case TokenType.HtmlTag:C.SmartHtmlEncodeAmps(B,p.startOffset,p.length);break;case TokenType.Html:case TokenType.opening_mark:case TokenType.closing_mark:case TokenType.internal_mark:C.Append(B.substr(p.startOffset,p.length));break;case TokenType.br:C.Append("<br />\n");break;case TokenType.open_em:C.Append("<em>");break;case TokenType.close_em:C.Append("</em>");break;case TokenType.open_strong:C.Append("<strong>");break;case TokenType.close_strong:C.Append("</strong>");break;case TokenType.code_span:C.Append("<code>");C.HtmlEncode(B,p.startOffset,p.length);C.Append("</code>");break;case TokenType.link:var b=p.data;var z=new k(this.m_Markdown);z.DisableLinks=true;b.def.RenderLink(this.m_Markdown,C,z.FormatDirect(b.link_text));break;case TokenType.img:var b=p.data;b.def.RenderImg(this.m_Markdown,C,b.link_text);break}}};q.Tokenize=function(){var i=this.m_Parser;var B=null;var b=null;var C=i.position;while(!i.eof()){var z=i.position;var y=null;switch(i.current()){case"*":case"_":y=this.CreateEmphasisMark();switch(y.type){case TokenType.internal_mark:case TokenType.opening_mark:case TokenType.closing_mark:if(b==null){b=new Array()}b.push(y);break}break;case"`":y=this.ProcessCodeSpan();break;case"[":case"!":var n=i.position;y=this.ProcessLinkOrImage();if(y==null){i.position=n}break;case"<":var A=i.position;var D=d.Parse(i);if(D!=null){y=this.CreateToken(TokenType.HtmlTag,A,i.position-A)}else{i.position=A;y=this.ProcessAutoLink();if(y==null){i.position=A}}break;case"&":var A=i.position;if(i.SkipHtmlEntity()){y=this.CreateToken(TokenType.Html,A,i.position-A)}break;case" ":if(i.CharAtOffset(1)==" "&&c.is_lineend(i.CharAtOffset(2))){i.SkipForward(2);if(!i.eof()){i.SkipEol();y=this.CreateToken(TokenType.br,z,0)}}break;case"\\":if(c.is_escapable(i.CharAtOffset(1))){y=this.CreateToken(TokenType.Text,i.position+1,1);i.SkipForward(2)}break}if(y!=null){if(B==null){B=new Array()}if(z>C){B.push(this.CreateToken(TokenType.Text,C,z-C))}B.push(y);C=i.position}else{i.SkipForward(1)}}if(B==null){return null}if(i.position>C){B.push(this.CreateToken(TokenType.Text,C,i.position-C))}if(b!=null){this.ResolveEmphasisMarks(B,b)}return B};q.CreateEmphasisMark=function(){var B=this.m_Parser;var n=B.current();var A=n=="*"?"_":"*";var z=B.position;if(B.bof()||c.is_whitespace(B.CharAtOffset(-1))){while(c.is_emphasis(B.current())){B.SkipForward(1)}if(B.eof()||c.is_whitespace(B.current())){return this.CreateToken(TokenType.Html,z,B.position-z)}B.position=z}while(c.is_emphasis(B.CharAtOffset(-1))){B.SkipForward(-1)}var b=B.bof()||c.is_whitespace(B.CharAtOffset(-1));B.position=z;while(B.current()==n){B.SkipForward(1)}var y=B.position-z;while(c.is_emphasis(B.CharAtOffset(1))){B.SkipForward(1)}var i=B.eof()||c.is_whitespace(B.CharAtOffset(1));B.position=z+y;if(b){return this.CreateToken(TokenType.opening_mark,z,B.position-z)}if(i){return this.CreateToken(TokenType.closing_mark,z,B.position-z)}return this.CreateToken(TokenType.internal_mark,z,B.position-z)};q.SplitMarkToken=function(y,n,i,b){var p=this.CreateToken(i.type,i.startOffset+b,i.length-b);i.length=b;n.splice(n.indexOf(i)+1,0,p);y.splice(y.indexOf(i)+1,0,p);return p};q.ResolveEmphasisMarks=function(A,C){var D=this.m_Parser.buf;var B=true;while(B){B=false;for(var y=0;y<C.length;y++){var z=C[y];if(z.type!=TokenType.opening_mark&&z.type!=TokenType.internal_mark){continue}for(var p=y+1;p<C.length;p++){var n=C[p];if(n.type!=TokenType.closing_mark&&n.type!=TokenType.internal_mark){break}if(D.charAt(z.startOffset)!=D.charAt(n.startOffset)){continue}var b=Math.min(z.length,n.length);if(b>=3){b=(b%2)==1?1:2}if(z.length>b){z=this.SplitMarkToken(A,C,z,z.length-b);y--}if(n.length>b){this.SplitMarkToken(A,C,n,b)}z.type=b==1?TokenType.open_em:TokenType.open_strong;n.type=b==1?TokenType.close_em:TokenType.close_strong;C.splice(C.indexOf(z),1);C.splice(C.indexOf(n),1);B=true;break}}}};q.ProcessAutoLink=function(){if(this.DisableLinks){return null}var z=this.m_Parser;z.SkipForward(1);z.Mark();while(!z.eof()){var y=z.current();if(c.is_whitespace(y)){break}if(y==">"){var n=o(z.Extract());var b=null;if(g(n)){var i;if(n.toLowerCase().substr(0,7)=="mailto:"){i=n.substr(7)}else{i=n;n="mailto:"+n}b=new e(new f("auto",n,null),i)}else{if(a(n)){b=new e(new f("auto",n,null),n)}}if(b!=null){z.SkipForward(1);return this.CreateDataToken(TokenType.link,b)}return null}z.SkipEscapableChar()}return null};q.ProcessLinkOrImage=function(){if(this.DisableLinks){return null}var z=this.m_Parser;var H=z.SkipChar("!")?TokenType.img:TokenType.link;if(!z.SkipChar("[")){return null}z.Mark();var G=1;while(!z.eof()){var b=z.current();if(b=="["){G++}else{if(b=="]"){G--;if(G==0){break}}}z.SkipEscapableChar()}if(z.eof()){return null}var n=o(z.Extract());z.SkipForward(1);var B=z.position;if(z.SkipChar("(")){var E=f.ParseLinkTarget(z,null);if(E==null){return null}z.SkipWhitespace();if(!z.SkipChar(")")){return null}return this.CreateDataToken(H,new e(E,n))}if(!z.SkipChar(" ")){z.SkipChar("\t")}if(z.eol()){z.SkipEol();z.SkipLinespace()}var C=null;if(z.current()=="["){z.SkipForward(1);z.Mark();if(!z.Find("]")){return null}C=z.Extract();z.SkipForward(1)}else{z.position=B}if(!C){C=n;while(true){var F=C.indexOf("\n");if(F<0){break}var y=F;while(y>0&&c.is_whitespace(C.charAt(y-1))){y--}var D=F;while(D<C.length&&c.is_whitespace(C.charAt(D))){D++}C=C.substr(0,y)+" "+C.substr(D)}}var A=this.m_Markdown.GetLinkDefinition(C);if(A==null){return null}return this.CreateDataToken(H,new e(A,n))};q.ProcessCodeSpan=function(){var z=this.m_Parser;var A=z.position;var n=0;while(z.SkipChar("`")){n++}z.SkipWhitespace();if(z.eof()){return this.CreateToken(TokenType.Text,A,z.position-A)}var i=z.position;if(!z.Find(z.buf.substr(A,n))){return this.CreateToken(TokenType.Text,A,z.position-A)}var y=z.position+n;while(c.is_whitespace(z.CharAtOffset(-1))){z.SkipForward(-1)}var b=this.CreateToken(TokenType.code_span,i,z.position-i);z.position=y;return b};q.CreateToken=function(n,b,p){if(this.m_SpareTokens.length!=0){var i=this.m_SpareTokens.pop();i.type=n;i.startOffset=b;i.length=p;i.data=null;return i}else{return new m(n,b,p)}};q.CreateDataToken=function(i,n){if(this.m_SpareTokens.length!=0){var b=this.m_SpareTokens.pop();b.type=i;b.data=n;return b}else{var b=new m(i,0,0);b.data=n;return b}};q.FreeToken=function(b){b.data=null;this.m_SpareTokens.push(b)};BlockType={};BlockType.Blank=0;BlockType.h1=1;BlockType.h2=2;BlockType.h3=3;BlockType.h4=4;BlockType.h5=5;BlockType.h6=6;BlockType.post_h1=7;BlockType.post_h2=8;BlockType.quote=9;BlockType.ol_li=10;BlockType.ul_li=11;BlockType.p=12;BlockType.indent=13;BlockType.hr=14;BlockType.html=15,BlockType.span=16;BlockType.codeblock=17;BlockType.li=18;BlockType.ol=19;BlockType.ul=20;function r(){}q=r.prototype;q.buf=null;q.blockType=BlockType.Blank;q.contentStart=0;q.contentLen=0;q.lineStart=0;q.lineLen=0;q.children=null;q.get_Content=function(){if(this.buf==null){return null}if(this.contentStart==-1){return this.buf}return this.buf.substr(this.contentStart,this.contentLen)};q.get_CodeContent=function(){var n=new j();for(var b=0;b<this.children.length;b++){n.Append(this.children[b].get_Content());n.Append("\n")}return n.ToString()};q.RenderChildren=function(p,n){for(var y=0;y<this.children.length;y++){this.children[y].Render(p,n)}};q.Render=function(p,n){switch(this.blockType){case BlockType.Blank:return;case BlockType.p:n.Append("<p>");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</p>\n");break;case BlockType.span:p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("\n");break;case BlockType.h1:case BlockType.h2:case BlockType.h3:case BlockType.h4:case BlockType.h5:case BlockType.h6:n.Append("<h"+(this.blockType-BlockType.h1+1).toString()+">");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</h"+(this.blockType-BlockType.h1+1).toString()+">\n");break;case BlockType.hr:n.Append("<hr />\n");return;case BlockType.ol_li:case BlockType.ul_li:n.Append("<li>");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</li>\n");break;case BlockType.html:n.Append(this.buf.substr(this.contentStart,this.contentLen));return;case BlockType.codeblock:n.Append("<pre><code>");for(var z=0;z<this.children.length;z++){var y=this.children[z];n.HtmlEncodeAndConvertTabsToSpaces(y.buf,y.contentStart,y.contentLen);n.Append("\n")}n.Append("</code></pre>\n\n");return;case BlockType.quote:n.Append("<blockquote>\n");this.RenderChildren(p,n);n.Append("</blockquote>\n");return;case BlockType.li:n.Append("<li>\n");this.RenderChildren(p,n);n.Append("</li>\n");return;case BlockType.ol:n.Append("<ol>\n");this.RenderChildren(p,n);n.Append("</ol>\n");return;case BlockType.ul:n.Append("<ul>\n");this.RenderChildren(p,n);n.Append("</ul>\n");return}};q.RevertToPlain=function(){this.blockType=BlockType.p;this.contentStart=this.lineStart;this.contentLen=this.lineLen};q.get_contentEnd=function(){return this.contentStart+this.contentLen};q.set_contentEnd=function(b){this.contentLen=b-this.contentStart};q.get_leadingSpaces=function(){var n=0;for(var b=this.lineStart;b<this.lineStart+this.lineLen;b++){if(this.buf.charAt(b)==" "){n++}else{break}}return n};q.CopyFrom=function(b){this.blockType=b.blockType;this.buf=b.buf;this.contentStart=b.contentStart;this.contentLen=b.contentLen;this.lineStart=b.lineStart;this.lineLen=b.lineLen;return this};function h(b){this.m_Markdown=b;this.m_parentType=BlockType.Blank}q=h.prototype;q.Process=function(B){var z=new l(B);var A=new Array();var n=new Array();while(!z.eof()){var i=this.EvaluateLine(z);if(i.blockType==BlockType.post_h1||i.blockType==BlockType.post_h2){if(n.length>0){var C=n.pop();this.CollapseLines(A,n);if(C.blockType!=BlockType.Blank){C.RevertToPlain();C.blockType=i.blockType==BlockType.post_h1?BlockType.h1:BlockType.h2;A.push(C);continue}}if(i.blockType==BlockType.post_h1){i.RevertToPlain();n.push(i)}else{if(i.contentLen>=3){i.blockType=BlockType.hr;A.push(i)}else{i.RevertToPlain();n.push(i)}}continue}var y=n.length>0?n[0].blockType:BlockType.Blank;switch(i.blockType){case BlockType.Blank:switch(y){case BlockType.Blank:this.FreeBlock(i);break;case BlockType.p:this.CollapseLines(A,n);this.FreeBlock(i);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:n.push(i);break}break;case BlockType.p:switch(y){case BlockType.Blank:case BlockType.p:n.push(i);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:var C=n[n.length-1];if(C.blockType==BlockType.Blank){this.CollapseLines(A,n);n.push(i)}else{n.push(i)}break;case BlockType.indent:this.CollapseLines(A,n);n.push(i);break}break;case BlockType.indent:switch(y){case BlockType.Blank:n.push(i);break;case BlockType.p:case BlockType.quote:var C=n[n.length-1];if(C.blockType==BlockType.Blank){this.CollapseLines(A,n);n.push(i)}else{i.RevertToPlain();n.push(i)}break;case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:n.push(i);break}break;case BlockType.quote:if(y!=BlockType.quote){this.CollapseLines(A,n)}n.push(i);break;case BlockType.ol_li:case BlockType.ul_li:switch(y){case BlockType.Blank:n.push(i);break;case BlockType.p:case BlockType.quote:var C=n[n.length-1];if(C.blockType==BlockType.Blank||this.m_parentType==BlockType.ol_li||this.m_parentType==BlockType.ul_li){this.CollapseLines(A,n);n.push(i)}else{i.RevertToPlain();n.push(i)}break;case BlockType.ol_li:case BlockType.ul_li:if(i.blockType!=y){this.CollapseLines(A,n)}n.push(i);break;case BlockType.indent:this.CollapseLines(A,n);n.push(i);break}break;case BlockType.h1:case BlockType.h2:case BlockType.h3:case BlockType.h4:case BlockType.h5:case BlockType.h6:case BlockType.html:case BlockType.hr:this.CollapseLines(A,n);A.push(i);break}}this.CollapseLines(A,n);return A};q.CreateBlock=function(){if(this.m_Markdown.m_SpareBlocks.length>1){return this.m_Markdown.m_SpareBlocks.pop()}else{return new r()}};q.FreeBlock=function(i){this.m_Markdown.m_SpareBlocks.push(i)};q.FreeBlocks=function(n){for(var b=0;b<n.length;b++){this.m_Markdown.m_SpareBlocks.push(n[b])}n.length=0};q.RenderLines=function(y){var n=this.m_Markdown.GetStringBuilder();for(var z=0;z<y.length;z++){var p=y[z];n.Append(p.buf.substr(p.contentStart,p.contentLen));n.Append("\n")}return n.ToString()};q.CollapseLines=function(C,n){while(n.length>0&&n[n.length-1].blockType==BlockType.Blank){this.FreeBlock(n.pop())}if(n.length==0){return}switch(n[0].blockType){case BlockType.p:var b=this.CreateBlock();b.blockType=BlockType.p;b.buf=n[0].buf;b.contentStart=n[0].contentStart;b.set_contentEnd(n[n.length-1].get_contentEnd());C.push(b);this.FreeBlocks(n);break;case BlockType.quote:var B=this.RenderLines(n);var A=new h(this.m_Markdown);A.m_parentType=BlockType.quote;var p=this.CreateBlock();p.blockType=BlockType.quote;p.children=A.Process(B);this.FreeBlocks(n);C.push(p);break;case BlockType.ol_li:case BlockType.ul_li:C.push(this.BuildList(n));break;case BlockType.indent:var z=this.CreateBlock();z.blockType=BlockType.codeblock;z.children=new Array();for(var y=0;y<n.length;y++){z.children.push(n[y])}C.push(z);n.length=0;break}};q.EvaluateLine=function(n){var i=this.CreateBlock();i.lineStart=n.position;i.buf=n.buf;i.contentStart=n.position;i.contentLen=-1;i.blockType=this.EvaluateLineInternal(n,i);n.SkipToEol();if(i.contentLen<0){i.contentLen=n.position-i.contentStart}i.lineLen=n.position-i.lineStart;n.SkipEol();return i};q.EvaluateLineInternal=function(y,F){if(y.eol()){return BlockType.Blank}var A=y.position;var i=y.current();if(i=="#"){var n=1;y.SkipForward(1);while(y.current()=="#"){n++;y.SkipForward(1)}if(n>6){n=6}y.SkipWhitespace();F.contentStart=y.position;y.SkipToEol();while(y.CharAtOffset(-1)=="#"){y.SkipForward(-1)}while(c.is_whitespace(y.CharAtOffset(-1))){y.SkipForward(-1)}F.contentLen=y.position-F.contentStart;y.SkipToEol();return BlockType.h1+(n-1)}if(i=="-"||i=="="){var D=i;while(y.current()==D){y.SkipForward(1)}y.SkipLinespace();if(y.eol()){return D=="="?BlockType.post_h1:BlockType.post_h2}y.position=A}var C=-1;var z=0;while(!y.eol()){if(y.current()==" "){if(C<0){z++}}else{if(y.current()=="\t"){if(C<0){C=y.position}}else{break}}y.SkipForward(1)}if(y.eol()){F.contentLen=0;return BlockType.Blank}if(z>=4){F.contentStart=A+4;return BlockType.indent}if(C>=0&&C-A<4){F.contentStart=C+1;return BlockType.indent}F.contentStart=y.position;i=y.current();if(i=="<"){if(this.ScanHtml(y)){F.contentLen=y.position-F.contentStart;return BlockType.html}y.position=F.contentStart}if(i==">"){if(c.is_linespace(y.CharAtOffset(1))){y.SkipForward(2);F.contentStart=y.position;return BlockType.quote}y.SkipForward(1);F.contentStart=y.position;return BlockType.quote}if(i=="-"||i=="_"||i=="*"){var E=0;while(!y.eol()){var D=y.current();if(y.current()==i){E++;y.SkipForward(1);continue}if(c.is_linespace(y.current())){y.SkipForward(1);continue}break}if(y.eol()&&E>=3){return BlockType.hr}y.position=F.contentStart}if((i=="*"||i=="+"||i=="-")&&c.is_linespace(y.CharAtOffset(1))){y.SkipForward(1);y.SkipLinespace();F.contentStart=y.position;return BlockType.ul_li}if(c.is_digit(i)){y.SkipForward(1);while(c.is_digit(y.current())){y.SkipForward(1)}if(y.SkipChar(".")&&y.SkipLinespace()){F.contentStart=y.position;return BlockType.ol_li}y.position=F.contentStart}if(i=="["){var B=f.ParseLinkDefinition(y);if(B!=null){this.m_Markdown.AddLinkDefinition(B);return BlockType.Blank}}return BlockType.p};q.ScanHtml=function(y){var n=d.Parse(y);if(n==null){return false}if(n.closing){return false}var i=n.get_Flags();if((i&HtmlTagFlags.NoClosing)!=0||n.closed){y.SkipLinespace();y.SkipEol();return true}if((i&HtmlTagFlags.Block)==0){return false}if((i&HtmlTagFlags.Inline)!=0){y.SkipLinespace();if(!y.eol()){return false}}var z=1;while(!y.eof()){if(y.current()!="<"){y.SkipForward(1);continue}var b=d.Parse(y);if(b==null){y.SkipForward(1);continue}if(b.name==n.name&&!b.closed){if(b.closing){z--;if(z==0){y.SkipLinespace();y.SkipEol();return true}}else{z++}}}return false};q.BuildList=function(J){var G=J[0].blockType;var D=J[0].leadingSpaces;for(var z=1;z<J.length;z++){if((J[z].blockType==BlockType.p)&&(J[z-1].blockType==BlockType.p||J[z-1].blockType==G)){J[z-1].set_contentEnd(J[z].get_contentEnd());this.FreeBlock(J[z]);J.splice(z,1);z--;continue}if(J[z].blockType!=BlockType.indent&&J[z].blockType!=BlockType.Blank){var K=J[z].leadingSpaces;if(K>D){J[z].blockType=BlockType.indent;var F=J[z].get_contentEnd();J[z].contentStart=J[z].lineStart+K;J[z].set_contentEnd(F)}}}var I=this.CreateBlock();I.blockType=(G==BlockType.ul_li?BlockType.ul:BlockType.ol);I.children=new Array();for(var z=0;z<J.length;z++){var A=z;while(A>0&&J[A-1].blockType==BlockType.Blank){A--}var C=z;while(C<J.length-1&&J[C+1].blockType!=G){C++}if(A==C){I.children.push(this.CreateBlock().CopyFrom(J[z]))}else{var B=false;var E=this.m_Markdown.GetStringBuilder();for(var y=A;y<=C;y++){var p=J[y];E.Append(p.buf.substr(p.contentStart,p.contentLen));E.Append("\n");if(J[y].blockType==BlockType.Blank){B=true}}var H=this.CreateBlock();H.blockType=BlockType.li;var b=new h(this.m_Markdown);b.m_parentType=G;H.children=b.Process(E.ToString());if(!B){for(var z=0;z<H.children.length;z++){var n=H.children[z];if(n.blockType==BlockType.p){n.blockType=BlockType.span}}}I.children.push(H)}z=C}this.FreeBlocks(J);J.length=0;return I};this.Markdown=s;this.StringBuilder=j;this.SpanFormatter=k;this.StringParser=l;this.BlockProcessor=h;this.LinkDefinition=f;this.HtmlTag=d;this.UnescapeString=o;this.BlockType=BlockType}();