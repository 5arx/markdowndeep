if(Array.prototype.indexOf==undefined){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]===b){return a}}return -1}}var MarkdownDeep=new function(){function w(){this.m_SpanFormatter=new m(this);this.m_SpareBlocks=new Array();this.m_StringBuilder=new l();this.SafeMode=false;this.ExtraMode=false;this.MarkdownInHtml=false;this.AutoHeadingIDs=false}var t=w.prototype;t.Transform=function(p){var E=p.indexOf("\r");if(E>=0){var G=p.indexOf("\n");if(G>=0){if(G<E){p=p.replace(/\n\r/g,"\n")}else{p=p.replace(/\r\n/g,"\n")}}p=p.replace(/\r/g,"\n")}this.m_LinkDefinitions=new Array();this.m_UsedHeaderIDs=new Array();var D=new j(this,this.MarkdownInHtml).Process(p);var F=this.GetStringBuilder();for(var s=0;s<D.length;s++){var n=D[s];n.Render(this,F)}return F.ToString()};t.AddLinkDefinition=function(b){this.m_LinkDefinitions[b.id]=b};t.GetLinkDefinition=function(i){var b=this.m_LinkDefinitions[i];if(b==undefined){return null}else{return b}};t.MakeUniqueHeaderID=function(n,b,s){if(!this.AutoHeadingIDs){return null}var D=this.m_SpanFormatter.MakeID(n,b,s);if(!D){D="section"}var p=D;var i=1;while(this.m_UsedHeaderIDs[p]!=undefined){p=D+"-"+i.toString();i++}this.m_UsedHeaderIDs[p]=true;return p};t.GetStringBuilder=function(){this.m_StringBuilder.Clear();return this.m_StringBuilder};t.processSpan=function(p,i,n,b){return this.m_SpanFormatter.Format(p,i,n,b)};var d={};d.is_digit=function(b){return b>="0"&&b<="9"};d.is_hex=function(b){return(b>="0"&&b<="9")||(b>="a"&&b<="f")||(b>="A"&&b<="F")};d.is_alpha=function(b){return(b>="a"&&b<="z")||(b>="A"&&b<="Z")};d.is_alphadigit=function(b){return(b>="a"&&b<="z")||(b>="A"&&b<="Z")||(b>="0"&&b<="9")};d.is_whitespace=function(b){return(b==" "||b=="\t"||b=="\r"||b=="\n")};d.is_linespace=function(b){return(b==" "||b=="\t")};d.is_lineend=function(b){return(b=="\r"||b=="\n")};d.is_emphasis=function(b){return(b=="*"||b=="_")};d.is_escapable=function(b){switch(b){case"\\":case"`":case"*":case"_":case"{":case"}":case"[":case"]":case"(":case")":case"#":case"+":case"-":case".":case"!":case">":return true}return false};function A(i,n){if(i.charAt(n)!="&"){return -1}var b=n;n++;if(i.charAt(n)=="#"){n++;if(i.charAt(n)=="x"||i.charAt(n)=="X"){n++;fn_test=d.is_hex}else{fn_test=d.is_digit}}else{fn_test=d.is_alphadigit}if(fn_test(i.charAt(n))){n++;while(fn_test(i.charAt(n))){n++}if(i.charAt(n)==";"){n++;return n}}n=b;return -1}function r(s){var n=s.indexOf("\\");if(n<0){return s}var i=new l();var p=0;while(n>=0){if(d.is_escapable(s.charAt(n+1))){if(n>p){i.Append(s.substr(p,n-p))}p=n+1}n=s.indexOf("\\",n+1)}if(p<s.length){i.Append(s.substr(p,s.length-p))}return i.ToString()}function C(p){var n=0;var b=p.length;while(n<b&&d.is_whitespace(p.charAt(n))){n++}while(b-1>n&&d.is_whitespace(p.charAt(n-1))){n--}return p.substr(n,b-n)}function h(n){var b=n.indexOf("@");if(b<0){return false}var i=n.lastIndexOf(".");if(i<b){return false}return true}function a(b){b=b.toLowerCase();if(b.substr(0,7)=="http://"){return true}if(b.substr(0,8)=="https://"){return true}if(b.substr(0,6)=="ftp://"){return true}if(b.substr(0,7)=="file://"){return true}return false}function c(p){if(!p){return false}if(!d.is_alpha(p.charAt(0))){return false}for(var b=0;b<p.length;b++){var n=p.charAt(b);if(d.is_alphadigit(n)||n=="_"||n=="-"||n==":"||n=="."){continue}return false}return true}function z(s,E,i){var D=i-1;while(D>=E&&d.is_whitespace(s.charAt(D))){D--}if(D<E||s.charAt(D)!="}"){return null}var p=D;D--;while(D>=E&&s.charAt(D)!="{"){D--}if(D<E||s.charAt(D+1)!="#"){return null}var b=D+2;var n=s.substr(b,p-b);if(!c(n)){return null}while(D>E&&d.is_whitespace(s.charAt(D-1))){D--}return{id:n,end:D}}function l(){this.content=new Array()}t=l.prototype;t.Append=function(b){if(b){this.content.push(b)}};t.Clear=function(){this.content.length=0};t.ToString=function(){return this.content.join("")};t.HtmlRandomize=function(p){var n=p.length;for(var s=0;s<n;s++){var b=Math.random();if(b>0.9&&p.charAt(s)!="@"){this.Append(p.charAt(s))}else{if(b>0.45){this.Append("&#");this.Append(p.charCodeAt(s).toString());this.Append(";")}else{this.Append("&#x");this.Append(p.charCodeAt(s).toString(16));this.Append(";")}}}};t.HtmlEncode=function(E,b,D){var n=b+D;var s=b;for(var p=b;p<n;p++){switch(E.charAt(p)){case"&":if(p>s){this.Append(E.substr(s,p-s))}this.Append("&amp;");s=p+1;break;case"<":if(p>s){this.Append(E.substr(s,p-s))}this.Append("&lt;");s=p+1;break;case">":if(p>s){this.Append(E.substr(s,p-s))}this.Append("&gt;");s=p+1;break;case'"':if(p>s){this.Append(E.substr(s,p-s))}this.Append("&quot;");s=p+1;break}}if(p>s){this.Append(E.substr(s,p-s))}};t.SmartHtmlEncodeAmpsAndAngles=function(F,b,D){var n=b+D;var s=b;for(var p=b;p<n;p++){switch(F.charAt(p)){case"&":var E=A(F,p);if(E<0){if(p>s){this.Append(F.substr(s,p-s))}this.Append("&amp;");s=p+1}else{p=E-1}break;case"<":if(p>s){this.Append(F.substr(s,p-s))}this.Append("&lt;");s=p+1;break;case">":if(p>s){this.Append(F.substr(s,p-s))}this.Append("&gt;");s=p+1;break;case'"':if(p>s){this.Append(F.substr(s,p-s))}this.Append("&quot;");s=p+1;break}}if(p>s){this.Append(F.substr(s,p-s))}};t.SmartHtmlEncodeAmps=function(F,b,D){var n=b+D;var s=b;for(var p=b;p<n;p++){switch(F.charAt(p)){case"&":var E=A(F,p);if(E<0){if(p>s){this.Append(F.substr(s,p-s))}this.Append("&amp;");s=p+1}else{p=E-1}break}}if(p>s){this.Append(F.substr(s,p-s))}};t.HtmlEncodeAndConvertTabsToSpaces=function(E,b,D){var n=b+D;var s=b;var F=0;for(var p=b;p<n;p++){switch(E.charAt(p)){case"\t":if(p>s){this.Append(E.substr(s,p-s))}s=p+1;this.Append(" ");F++;while((F%4)!=0){this.Append(" ");F++}F--;break;case"&":if(p>s){this.Append(E.substr(s,p-s))}this.Append("&amp;");s=p+1;break;case"<":if(p>s){this.Append(E.substr(s,p-s))}this.Append("&lt;");s=p+1;break;case">":if(p>s){this.Append(E.substr(s,p-s))}this.Append("&gt;");s=p+1;break;case'"':if(p>s){this.Append(E.substr(s,p-s))}this.Append("&quot;");s=p+1;break}F++}if(p>s){this.Append(E.substr(s,p-s))}};function k(){this.reset.apply(this,arguments)}t=k.prototype;t.bof=function(){return this.position==this.start};t.eof=function(){return this.position>=this.end};t.eol=function(){if(this.position>=this.end){return true}var b=this.buf.charAt(this.position);return b=="\r"||b=="\n"||b==undefined||b==""};t.reset=function(){this.buf=arguments.length>0?arguments[0]:null;this.start=arguments.length>1?arguments[1]:0;this.end=arguments.length>2?this.start+arguments[2]:(this.buf==null?0:this.buf.length);this.position=this.start;this.charset_offsets={}};t.current=function(){if(this.position>=this.end){return"\0"}return this.buf.charAt(this.position)};t.remainder=function(){return this.buf.substr(this.position)};t.SkipToEof=function(){this.position=this.end};t.SkipForward=function(b){this.position+=b};t.SkipToEol=function(){this.position=this.buf.indexOf("\n",this.position);if(this.position<0){this.position=this.end}};t.SkipEol=function(){var b=this.position;if(this.buf.charAt(this.position)=="\r"){this.position++}if(this.buf.charAt(this.position)=="\n"){this.position++}return this.position!=b};t.SkipToNextLine=function(){this.SkipToEol();this.SkipEol()};t.CharAtOffset=function(b){if(this.position+b>=this.end){return"\0"}return this.buf.charAt(this.position+b)};t.SkipChar=function(b){if(this.buf.charAt(this.position)==b){this.position++;return true}return false};t.SkipString=function(b){if(this.buf.substr(this.position,b.length)==b){this.position+=b.length;return true}return false};t.SkipWhitespace=function(){var i=this.position;while(true){var b=this.buf.charAt(this.position);if(b!=" "&&b!="\t"&&b!="\r"&&b!="\n"){break}this.position++}return this.position!=i};t.SkipLinespace=function(){var i=this.position;while(true){var b=this.buf.charAt(this.position);if(b!=" "&&b!="\t"){break}this.position++}return this.position!=i};t.FindRE=function(i){i.lastIndex=this.position;var b=i.exec(this.buf);if(b==null){this.position=this.end;return false}if(b.index+b[0].length>this.end){this.position=this.end;return false}this.position=b.index;return true};t.FindOneOf=function(p){var i=-1;for(var b in p){var n=p[b];if(n==null){n={};n.searched_from=-1;n.found_at=-1;p[b]=n}if(n.searched_from==-1||this.position<n.searched_from||(this.position>=n.found_at&&n.found_at!=-1)){n.searched_from=this.position;n.found_at=this.buf.indexOf(b,this.position)}if(i==-1||n.found_at<i){i=n.found_at}}if(i==-1){i=this.end;return false}t.position=i;return true};t.Find=function(b){this.position=this.buf.indexOf(b,this.position);if(this.position<0){this.position=this.end;return false}return true};t.Mark=function(){this.mark=this.position};t.Extract=function(){if(this.mark>=this.position){return""}else{return this.buf.substr(this.mark,this.position-this.mark)}};t.SkipIdentifier=function(){var b=this.buf.charAt(this.position);if((b>="a"&&b<="z")||(b>="A"&&b<="Z")||b=="_"){this.position++;while(true){var b=this.buf.charAt(this.position);if((b>="a"&&b<="z")||(b>="A"&&b<="Z")||b=="_"||(b>="0"&&b<="9")){this.position++}else{return true}}}return false};t.SkipHtmlEntity=function(){if(this.buf.charAt(this.position)!="&"){return false}var b=A(this.buf,this.position);if(b<0){return false}this.position=b;return true};t.SkipEscapableChar=function(){if(this.buf.charAt(this.position)=="\\"&&d.is_escapable(this.buf.charAt(this.position+1))){this.position+=2;return true}else{if(this.position<this.end){this.position++}return false}};HtmlTagFlags={};HtmlTagFlags.Block=1;HtmlTagFlags.Inline=2;HtmlTagFlags.NoClosing=4;HtmlTagFlags.ContentAsSpan=8;function e(b){this.name=b;this.attributes={};this.flags=0}t=e.prototype;t.attributes=null;t.closed=false;t.closing=false;t.attributeCount=function(){if(!this.attributes){return 0}var i=0;for(var b in this.attributes){i++}return i};t.get_Flags=function(){if(this.flags==0){this.flags=tag_flags[this.name.toLowerCase()];if(this.flags==undefined){this.flags=HtmlTagFlags.Inline}}return this.flags};t.IsSafe=function(){var b=this.name.toLowerCase();if(!allowed_tags[b]){return false}var p=allowed_attributes[b];if(!p){return this.attributeCount()==0}if(!this.attributes){return true}for(var n in this.attributes){if(!p[n.toLowerCase()]){return false}}if(this.attributes.href){if(!e.IsSafeUrl(this.attributes.href)){return false}}if(this.attributes.src){if(!e.IsSafeUrl(this.attributes.src)){return false}}return true};t.RenderOpening=function(b){b.Append("<");b.Append(this.name);for(var n in this.m_attributes){b.Append(" ");b.Append(n);b.Append('="');b.Append(this.m_attributes[n]);b.Append('"')}b.Append(">\n")};t.RenderClosing=function(b){b.Append("</");b.Append(this.name);b.Append(">\n")};e.IsSafeUrl=function(b){b=b.toLowerCase();return(b.substr(0,7)=="http://"||b.substr(0,8)=="https://"||b.substr(0,6)=="ftp://")};e.Parse=function(n){var i=n.position;var b=this.ParseHelper(n);if(b!=null){return b}n.position=i;return null};e.ParseHelper=function(D){if(D.current()!="<"){return null}D.SkipForward(1);if(D.SkipString("!--")){D.Mark();if(D.Find("-->")){var n=new e("!");n.attributes.content=D.Extract();n.closed=true;D.SkipForward(3);return n}}var s=D.SkipChar("/");D.Mark();if(!D.SkipIdentifier()){return null}var b=new e(D.Extract());b.closing=s;if(s){if(D.current()!=">"){return null}D.SkipForward(1);return b}while(!D.eof()){D.SkipWhitespace();if(D.SkipString("/>")){b.closed=true;return b}if(D.SkipChar(">")){return b}D.Mark();if(!D.SkipIdentifier()){return null}var i=D.Extract();D.SkipWhitespace();if(!D.SkipChar("=")){return null}D.SkipWhitespace();if(D.SkipChar('"')){D.Mark();if(!D.Find('"')){return null}b.attributes[i]=D.Extract();D.SkipForward(1)}else{D.Mark();while(!D.eof()&&!d.is_whitespace(D.current())&&D.current()!=">"&&D.current()!="/"){D.SkipForward(1)}if(!D.eof()){b.attributes[i]=D.Extract()}}}return null};allowed_tags={b:1,blockquote:1,code:1,dd:1,dt:1,dl:1,del:1,em:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,i:1,kbd:1,li:1,ol:1,ul:1,p:1,pre:1,s:1,sub:1,sup:1,strong:1,strike:1,img:1,a:1};allowed_attributes={a:{href:1,title:1},img:{src:1,width:1,height:1,alt:1,title:1}};var B=HtmlTagFlags.Block;var y=HtmlTagFlags.Inline;var x=HtmlTagFlags.NoClosing;var o=HtmlTagFlags.ContentAsSpan;tag_flags={p:B|o,div:B,h1:B|o,h2:B|o,h3:B|o,h4:B|o,h5:B|o,h6:B|o,blockquote:B,pre:B,table:B,dl:B,ol:B,ul:B,form:B,fieldset:B,iframe:B,script:B|y,noscript:B|y,math:B|y,ins:B|y,del:B|y,img:B|y,li:o,dd:o,dt:o,td:o,th:o,legend:o,address:o,hr:B|x,"!":B|x};delete B;delete y;delete x;function g(n,b,i){this.id=n;this.url=b;if(i==undefined){this.title=null}else{this.title=i}}t=g.prototype;t.RenderLink=function(n,i,p){if(this.url.substr(0,7).toLowerCase()=="mailto:"){i.Append('<a href="');i.HtmlRandomize(this.url);i.Append('"');if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(">");i.HtmlRandomize(p);i.Append("</a>")}else{i.Append('<a href="');i.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);i.Append('"');if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(">");i.Append(p);i.Append("</a>")}};t.RenderImg=function(n,i,p){i.Append('<img src="');i.SmartHtmlEncodeAmpsAndAngles(this.url,0,this.url.length);i.Append('"');if(p){i.Append(' alt="');i.SmartHtmlEncodeAmpsAndAngles(p,0,p.length);i.Append('"')}if(this.title){i.Append(' title="');i.SmartHtmlEncodeAmpsAndAngles(this.title,0,this.title.length);i.Append('"')}i.Append(" />")};g.ParseLinkDefinition=function(n){var i=n.position;var b=g.ParseLinkDefinitionInternal(n);if(b==null){n.position=i}return b};g.ParseLinkDefinitionInternal=function(i){i.SkipWhitespace();if(!i.SkipChar("[")){return null}i.Mark();if(!i.Find("]")){return null}var n=i.Extract();if(n.length==0){return null}if(!i.SkipString("]:")){return null}var b=this.ParseLinkTarget(i,n);i.SkipLinespace();if(!i.eol()){return null}return b};g.ParseLinkTarget=function(E,D){E.SkipWhitespace();if(E.eol()){return null}var b=new g(D);if(E.SkipChar("<")){E.Mark();while(E.current()!=">"){if(E.eof()){return null}E.SkipEscapableChar()}var s=E.Extract();if(!E.SkipChar(">")){return null}b.url=r(C(s));E.SkipWhitespace()}else{E.Mark();var n=1;while(!E.eol()){var i=E.current();if(d.is_whitespace(i)){break}if(D==null){if(i=="("){n++}else{if(i==")"){n--;if(n==0){break}}}}E.SkipEscapableChar()}b.url=r(C(E.Extract()))}E.SkipLinespace();if(E.current()==")"){return b}var I=E.eol();var H=E.position;if(E.eol()){E.SkipEol();E.SkipLinespace()}var G;switch(E.current()){case"'":case'"':G=E.current();break;case"(":G=")";break;default:if(I){E.position=H;return b}else{return null}}E.SkipForward(1);E.Mark();while(true){if(E.eol()){return null}if(E.current()==G){if(G!=")"){var F=E.position;E.SkipForward(1);E.SkipLinespace();if((D==null&&E.current()!=")")||(D!=null&&!E.eol())){continue}E.position=F}break}E.SkipEscapableChar()}b.title=r(E.Extract());E.SkipForward(1);return b};function f(i,b){this.def=i;this.link_text=b}TokenType={};TokenType.Text=0;TokenType.HtmlTag=1;TokenType.Html=2;TokenType.open_em=3;TokenType.close_em=4;TokenType.open_strong=5;TokenType.close_strong=6;TokenType.code_span=7;TokenType.br=8;TokenType.link=9;TokenType.img=10;TokenType.opening_mark=11;TokenType.closing_mark=12;TokenType.internal_mark=13;function q(i,b,n){this.type=i;this.startOffset=b;this.length=n;this.data=null}function m(b){this.m_Markdown=b;this.m_Scanner=new k();this.m_SpareTokens=new Array();this.DisableLinks=false}t=m.prototype;t.Format=function(n,D,E,b){this.m_Scanner.reset(D,E,b);var s=this.Tokenize();if(s==null){n.HtmlEncode(D,E,b)}else{this.RenderTokens(n,D,s);for(var p=0;p<s.length;p++){this.FreeToken(s[p])}}};t.FormatDirect=function(i){var b=new l();this.Format(b,i,0,i.length);return b.ToString()};t.MakeID=function(F,n,E){var s=this.m_Scanner;s.reset(F,n,E);var G=this.Tokenize();var H=new l();if(G==null){H.Append(F.substr(n,E))}else{for(var D=0;D<G.length;D++){var I=G[D];switch(I.type){case TokenType.Text:H.Append(F.substr(I.startOffset,I.length));break;case TokenType.link:H.Append(I.data.link_text);break}}}s.reset(H.ToString());while(!s.eof()){if(d.is_alpha(s.current())){break}s.SkipForward(1)}H.Clear();while(!s.eof()){var b=s.current();if(d.is_alphadigit(b)||b=="_"||b=="-"||b=="."){H.Append(b.toLowerCase())}else{if(b==" "){H.Append("-")}else{if(d.is_lineend(b)){H.Append("-");s.SkipEol();continue}}}s.SkipForward(1)}return H.ToString()};t.RenderTokens=function(G,F,E){var n=E.length;for(var s=0;s<n;s++){var p=E[s];switch(p.type){case TokenType.Text:G.HtmlEncode(F,p.startOffset,p.length);break;case TokenType.HtmlTag:G.SmartHtmlEncodeAmps(F,p.startOffset,p.length);break;case TokenType.Html:case TokenType.opening_mark:case TokenType.closing_mark:case TokenType.internal_mark:G.Append(F.substr(p.startOffset,p.length));break;case TokenType.br:G.Append("<br />\n");break;case TokenType.open_em:G.Append("<em>");break;case TokenType.close_em:G.Append("</em>");break;case TokenType.open_strong:G.Append("<strong>");break;case TokenType.close_strong:G.Append("</strong>");break;case TokenType.code_span:G.Append("<code>");G.HtmlEncode(F,p.startOffset,p.length);G.Append("</code>");break;case TokenType.link:var b=p.data;var D=new m(this.m_Markdown);D.DisableLinks=true;b.def.RenderLink(this.m_Markdown,G,D.FormatDirect(b.link_text));break;case TokenType.img:var b=p.data;b.def.RenderImg(this.m_Markdown,G,b.link_text);break}}};t.Tokenize=function(){var i=this.m_Scanner;var F=null;var b=null;var H=/[\*\_\`\[\!\<\&\ \\]/g;var G=i.position;while(!i.eof()){if(!i.FindRE(H)){break}var D=i.position;var s=null;switch(i.current()){case"*":case"_":s=this.CreateEmphasisMark();switch(s.type){case TokenType.internal_mark:case TokenType.opening_mark:case TokenType.closing_mark:if(b==null){b=new Array()}b.push(s);break}break;case"`":s=this.ProcessCodeSpan();break;case"[":case"!":var n=i.position;s=this.ProcessLinkOrImage();if(s==null){i.position=n}break;case"<":var E=i.position;var I=e.Parse(i);if(I!=null){if(!this.m_Markdown.SafeMode||I.IsSafe()){s=this.CreateToken(TokenType.HtmlTag,E,i.position-E)}else{i.position=E}}else{i.position=E;s=this.ProcessAutoLink();if(s==null){i.position=E}}break;case"&":var E=i.position;if(i.SkipHtmlEntity()){s=this.CreateToken(TokenType.Html,E,i.position-E)}break;case" ":if(i.CharAtOffset(1)==" "&&d.is_lineend(i.CharAtOffset(2))){i.SkipForward(2);if(!i.eof()){i.SkipEol();s=this.CreateToken(TokenType.br,D,0)}}break;case"\\":if(d.is_escapable(i.CharAtOffset(1))){s=this.CreateToken(TokenType.Text,i.position+1,1);i.SkipForward(2)}break}if(s!=null){if(F==null){F=new Array()}if(D>G){F.push(this.CreateToken(TokenType.Text,G,D-G))}F.push(s);G=i.position}else{i.SkipForward(1)}}if(F==null){return null}if(i.position>G){F.push(this.CreateToken(TokenType.Text,G,i.position-G))}if(b!=null){this.ResolveEmphasisMarks(F,b)}return F};t.CreateEmphasisMark=function(){var F=this.m_Scanner;var n=F.current();var E=n=="*"?"_":"*";var D=F.position;if(F.bof()||d.is_whitespace(F.CharAtOffset(-1))){while(d.is_emphasis(F.current())){F.SkipForward(1)}if(F.eof()||d.is_whitespace(F.current())){return this.CreateToken(TokenType.Html,D,F.position-D)}F.position=D}while(d.is_emphasis(F.CharAtOffset(-1))){F.SkipForward(-1)}var b=F.bof()||d.is_whitespace(F.CharAtOffset(-1));F.position=D;while(F.current()==n){F.SkipForward(1)}var s=F.position-D;while(d.is_emphasis(F.CharAtOffset(1))){F.SkipForward(1)}var i=F.eof()||d.is_whitespace(F.CharAtOffset(1));F.position=D+s;if(b){return this.CreateToken(TokenType.opening_mark,D,F.position-D)}if(i){return this.CreateToken(TokenType.closing_mark,D,F.position-D)}return this.CreateToken(TokenType.internal_mark,D,F.position-D)};t.SplitMarkToken=function(s,n,i,b){var p=this.CreateToken(i.type,i.startOffset+b,i.length-b);i.length=b;n.splice(n.indexOf(i)+1,0,p);s.splice(s.indexOf(i)+1,0,p);return p};t.ResolveEmphasisMarks=function(E,G){var H=this.m_Scanner.buf;var F=true;while(F){F=false;for(var s=0;s<G.length;s++){var D=G[s];if(D.type!=TokenType.opening_mark&&D.type!=TokenType.internal_mark){continue}for(var p=s+1;p<G.length;p++){var n=G[p];if(n.type!=TokenType.closing_mark&&n.type!=TokenType.internal_mark){break}if(H.charAt(D.startOffset)!=H.charAt(n.startOffset)){continue}var b=Math.min(D.length,n.length);if(b>=3){b=(b%2)==1?1:2}if(D.length>b){D=this.SplitMarkToken(E,G,D,D.length-b);s--}if(n.length>b){this.SplitMarkToken(E,G,n,b)}D.type=b==1?TokenType.open_em:TokenType.open_strong;n.type=b==1?TokenType.close_em:TokenType.close_strong;G.splice(G.indexOf(D),1);G.splice(G.indexOf(n),1);F=true;break}}}};t.ProcessAutoLink=function(){if(this.DisableLinks){return null}var D=this.m_Scanner;D.SkipForward(1);D.Mark();while(!D.eof()){var s=D.current();if(d.is_whitespace(s)){break}if(s==">"){var n=r(D.Extract());var b=null;if(h(n)){var i;if(n.toLowerCase().substr(0,7)=="mailto:"){i=n.substr(7)}else{i=n;n="mailto:"+n}b=new f(new g("auto",n,null),i)}else{if(a(n)){b=new f(new g("auto",n,null),n)}}if(b!=null){D.SkipForward(1);return this.CreateDataToken(TokenType.link,b)}return null}D.SkipEscapableChar()}return null};t.ProcessLinkOrImage=function(){if(this.DisableLinks){return null}var D=this.m_Scanner;var L=D.SkipChar("!")?TokenType.img:TokenType.link;if(!D.SkipChar("[")){return null}D.Mark();var K=1;while(!D.eof()){var b=D.current();if(b=="["){K++}else{if(b=="]"){K--;if(K==0){break}}}D.SkipEscapableChar()}if(D.eof()){return null}var n=r(D.Extract());D.SkipForward(1);var F=D.position;if(D.SkipChar("(")){var I=g.ParseLinkTarget(D,null);if(I==null){return null}D.SkipWhitespace();if(!D.SkipChar(")")){return null}return this.CreateDataToken(L,new f(I,n))}if(!D.SkipChar(" ")){D.SkipChar("\t")}if(D.eol()){D.SkipEol();D.SkipLinespace()}var G=null;if(D.current()=="["){D.SkipForward(1);D.Mark();if(!D.Find("]")){return null}G=D.Extract();D.SkipForward(1)}else{D.position=F}if(!G){G=n;while(true){var J=G.indexOf("\n");if(J<0){break}var s=J;while(s>0&&d.is_whitespace(G.charAt(s-1))){s--}var H=J;while(H<G.length&&d.is_whitespace(G.charAt(H))){H++}G=G.substr(0,s)+" "+G.substr(H)}}var E=this.m_Markdown.GetLinkDefinition(G);if(E==null){return null}return this.CreateDataToken(L,new f(E,n))};t.ProcessCodeSpan=function(){var D=this.m_Scanner;var E=D.position;var n=0;while(D.SkipChar("`")){n++}D.SkipWhitespace();if(D.eof()){return this.CreateToken(TokenType.Text,E,D.position-E)}var i=D.position;if(!D.Find(D.buf.substr(E,n))){return this.CreateToken(TokenType.Text,E,D.position-E)}var s=D.position+n;while(d.is_whitespace(D.CharAtOffset(-1))){D.SkipForward(-1)}var b=this.CreateToken(TokenType.code_span,i,D.position-i);D.position=s;return b};t.CreateToken=function(n,b,p){if(this.m_SpareTokens.length!=0){var i=this.m_SpareTokens.pop();i.type=n;i.startOffset=b;i.length=p;i.data=null;return i}else{return new q(n,b,p)}};t.CreateDataToken=function(i,n){if(this.m_SpareTokens.length!=0){var b=this.m_SpareTokens.pop();b.type=i;b.data=n;return b}else{var b=new q(i,0,0);b.data=n;return b}};t.FreeToken=function(b){b.data=null;this.m_SpareTokens.push(b)};BlockType={};BlockType.Blank=0;BlockType.h1=1;BlockType.h2=2;BlockType.h3=3;BlockType.h4=4;BlockType.h5=5;BlockType.h6=6;BlockType.post_h1=7;BlockType.post_h2=8;BlockType.quote=9;BlockType.ol_li=10;BlockType.ul_li=11;BlockType.p=12;BlockType.indent=13;BlockType.hr=14;BlockType.html=15;BlockType.unsafe_html=16;BlockType.span=17;BlockType.codeblock=18;BlockType.li=19;BlockType.ol=20;BlockType.ul=21;BlockType.HtmlTag=22;BlockType.Composite=23;function v(){}t=v.prototype;t.buf=null;t.blockType=BlockType.Blank;t.contentStart=0;t.contentLen=0;t.lineStart=0;t.lineLen=0;t.children=null;t.data=null;t.get_Content=function(){if(this.buf==null){return null}if(this.contentStart==-1){return this.buf}return this.buf.substr(this.contentStart,this.contentLen)};t.get_CodeContent=function(){var n=new l();for(var b=0;b<this.children.length;b++){n.Append(this.children[b].get_Content());n.Append("\n")}return n.ToString()};t.RenderChildren=function(p,n){for(var s=0;s<this.children.length;s++){this.children[s].Render(p,n)}};t.ResolveHeaderID=function(b){if(this.data!=null){return this.data}var i=z(this.buf,this.contentStart,this.get_contentEnd());var n=null;if(i!=null){this.set_contentEnd(i.end);n=i.id}else{n=b.MakeUniqueHeaderID(this.buf,this.contentStart,this.contentLen)}this.data=n;return n};t.Render=function(p,n){switch(this.blockType){case BlockType.Blank:return;case BlockType.p:n.Append("<p>");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</p>\n");break;case BlockType.span:p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("\n");break;case BlockType.h1:case BlockType.h2:case BlockType.h3:case BlockType.h4:case BlockType.h5:case BlockType.h6:if(p.ExtraMode&&!p.SafeMode){n.Append("<h"+(this.blockType-BlockType.h1+1).toString());var E=this.ResolveHeaderID(p);if(E){n.Append(' id="');n.Append(E);n.Append('">')}else{n.Append(">")}}else{n.Append("<"+(this.blockType-BlockType.h1+1).toString()+">")}p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</h"+(this.blockType-BlockType.h1+1).toString()+">\n");break;case BlockType.hr:n.Append("<hr />\n");return;case BlockType.ol_li:case BlockType.ul_li:n.Append("<li>");p.processSpan(n,this.buf,this.contentStart,this.contentLen);n.Append("</li>\n");break;case BlockType.html:n.Append(this.buf.substr(this.contentStart,this.contentLen));return;case BlockType.unsafe_html:n.HtmlEncode(this.buf,this.contentStart,this.contentLen);return;case BlockType.codeblock:n.Append("<pre><code>");for(var D=0;D<this.children.length;D++){var s=this.children[D];n.HtmlEncodeAndConvertTabsToSpaces(s.buf,s.contentStart,s.contentLen);n.Append("\n")}n.Append("</code></pre>\n\n");return;case BlockType.quote:n.Append("<blockquote>\n");this.RenderChildren(p,n);n.Append("</blockquote>\n");return;case BlockType.li:n.Append("<li>\n");this.RenderChildren(p,n);n.Append("</li>\n");return;case BlockType.ol:n.Append("<ol>\n");this.RenderChildren(p,n);n.Append("</ol>\n");return;case BlockType.ul:n.Append("<ul>\n");this.RenderChildren(p,n);n.Append("</ul>\n");return;case BlockType.HtmlTag:this.data.RenderOpening(n);this.RenderChildren(p,n);this.data.RenderClosing(n);return;case BlockType.Composite:this.RenderChildren(p,n);return}};t.RevertToPlain=function(){this.blockType=BlockType.p;this.contentStart=this.lineStart;this.contentLen=this.lineLen};t.get_contentEnd=function(){return this.contentStart+this.contentLen};t.set_contentEnd=function(b){this.contentLen=b-this.contentStart};t.get_leadingSpaces=function(){var n=0;for(var b=this.lineStart;b<this.lineStart+this.lineLen;b++){if(this.buf.charAt(b)==" "){n++}else{break}}return n};t.CopyFrom=function(b){this.blockType=b.blockType;this.buf=b.buf;this.contentStart=b.contentStart;this.contentLen=b.contentLen;this.lineStart=b.lineStart;this.lineLen=b.lineLen;return this};function j(b,i){this.m_Markdown=b;this.m_parentType=BlockType.Blank;this.m_bMarkdownInHtml=i}t=j.prototype;t.Process=function(i){var b=new k(i);return this.ScanLines(b)};t.ProcessRange=function(s,i,b){var n=new k(s,i,b);return this.ScanLines(n)};t.ScanLines=function(D){var E=new Array();var n=new Array();while(!D.eof()){var i=this.EvaluateLine(D);if(i.blockType==BlockType.post_h1||i.blockType==BlockType.post_h2){if(n.length>0){var F=n.pop();this.CollapseLines(E,n);if(F.blockType!=BlockType.Blank){F.RevertToPlain();F.blockType=i.blockType==BlockType.post_h1?BlockType.h1:BlockType.h2;E.push(F);continue}}if(i.blockType==BlockType.post_h1){i.RevertToPlain();n.push(i)}else{if(i.contentLen>=3){i.blockType=BlockType.hr;E.push(i)}else{i.RevertToPlain();n.push(i)}}continue}var s=n.length>0?n[0].blockType:BlockType.Blank;switch(i.blockType){case BlockType.Blank:switch(s){case BlockType.Blank:this.FreeBlock(i);break;case BlockType.p:this.CollapseLines(E,n);this.FreeBlock(i);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:n.push(i);break}break;case BlockType.p:switch(s){case BlockType.Blank:case BlockType.p:n.push(i);break;case BlockType.quote:case BlockType.ol_li:case BlockType.ul_li:var F=n[n.length-1];if(F.blockType==BlockType.Blank){this.CollapseLines(E,n);n.push(i)}else{n.push(i)}break;case BlockType.indent:this.CollapseLines(E,n);n.push(i);break}break;case BlockType.indent:switch(s){case BlockType.Blank:n.push(i);break;case BlockType.p:case BlockType.quote:var F=n[n.length-1];if(F.blockType==BlockType.Blank){this.CollapseLines(E,n);n.push(i)}else{i.RevertToPlain();n.push(i)}break;case BlockType.ol_li:case BlockType.ul_li:case BlockType.indent:n.push(i);break}break;case BlockType.quote:if(s!=BlockType.quote){this.CollapseLines(E,n)}n.push(i);break;case BlockType.ol_li:case BlockType.ul_li:switch(s){case BlockType.Blank:n.push(i);break;case BlockType.p:case BlockType.quote:var F=n[n.length-1];if(F.blockType==BlockType.Blank||this.m_parentType==BlockType.ol_li||this.m_parentType==BlockType.ul_li){this.CollapseLines(E,n);n.push(i)}else{i.RevertToPlain();n.push(i)}break;case BlockType.ol_li:case BlockType.ul_li:if(i.blockType!=s){this.CollapseLines(E,n)}n.push(i);break;case BlockType.indent:this.CollapseLines(E,n);n.push(i);break}break;default:this.CollapseLines(E,n);E.push(i);break}}this.CollapseLines(E,n);return E};t.CreateBlock=function(){if(this.m_Markdown.m_SpareBlocks.length>1){return this.m_Markdown.m_SpareBlocks.pop()}else{return new v()}};t.FreeBlock=function(i){this.m_Markdown.m_SpareBlocks.push(i)};t.FreeBlocks=function(n){for(var b=0;b<n.length;b++){this.m_Markdown.m_SpareBlocks.push(n[b])}n.length=0};t.RenderLines=function(s){var n=this.m_Markdown.GetStringBuilder();for(var D=0;D<s.length;D++){var p=s[D];n.Append(p.buf.substr(p.contentStart,p.contentLen));n.Append("\n")}return n.ToString()};t.CollapseLines=function(G,n){while(n.length>0&&n[n.length-1].blockType==BlockType.Blank){this.FreeBlock(n.pop())}if(n.length==0){return}switch(n[0].blockType){case BlockType.p:var b=this.CreateBlock();b.blockType=BlockType.p;b.buf=n[0].buf;b.contentStart=n[0].contentStart;b.set_contentEnd(n[n.length-1].get_contentEnd());G.push(b);this.FreeBlocks(n);break;case BlockType.quote:var F=this.RenderLines(n);var E=new j(this.m_Markdown,this.m_bMarkdownInHtml);E.m_parentType=BlockType.quote;var p=this.CreateBlock();p.blockType=BlockType.quote;p.children=E.Process(F);this.FreeBlocks(n);G.push(p);break;case BlockType.ol_li:case BlockType.ul_li:G.push(this.BuildList(n));break;case BlockType.indent:var D=this.CreateBlock();D.blockType=BlockType.codeblock;D.children=new Array();for(var s=0;s<n.length;s++){D.children.push(n[s])}G.push(D);n.length=0;break}};t.EvaluateLine=function(n){var i=this.CreateBlock();i.lineStart=n.position;i.buf=n.buf;i.contentStart=n.position;i.contentLen=-1;i.blockType=this.EvaluateLineInternal(n,i);if(i.contentLen<0){n.SkipToEol();i.contentLen=n.position-i.contentStart}i.lineLen=n.position-i.lineStart;n.SkipEol();return i};t.EvaluateLineInternal=function(s,K){if(s.eol()){return BlockType.Blank}var E=s.position;var i=s.current();if(i=="#"){var n=1;s.SkipForward(1);while(s.current()=="#"){n++;s.SkipForward(1)}if(n>6){n=6}s.SkipWhitespace();K.contentStart=s.position;s.SkipToEol();if(this.m_Markdown.ExtraMode&&!this.m_Markdown.SafeMode){var J=z(s.buf,K.contentStart,s.position);if(J!=null){K.data=J.id;s.position=J.end}}while(s.position>K.contentStart&&s.CharAtOffset(-1)=="#"){s.SkipForward(-1)}while(s.position>K.contentStart&&d.is_whitespace(s.CharAtOffset(-1))){s.SkipForward(-1)}K.contentLen=s.position-K.contentStart;s.SkipToEol();return BlockType.h1+(n-1)}if(i=="-"||i=="="){var H=i;while(s.current()==H){s.SkipForward(1)}s.SkipLinespace();if(s.eol()){return H=="="?BlockType.post_h1:BlockType.post_h2}s.position=E}var G=-1;var D=0;while(!s.eol()){if(s.current()==" "){if(G<0){D++}}else{if(s.current()=="\t"){if(G<0){G=s.position}}else{break}}s.SkipForward(1)}if(s.eol()){K.contentLen=0;return BlockType.Blank}if(D>=4){K.contentStart=E+4;return BlockType.indent}if(G>=0&&G-E<4){K.contentStart=G+1;return BlockType.indent}K.contentStart=s.position;i=s.current();if(i=="<"){if(this.ScanHtml(s,K)){return K.blockType}s.position=K.contentStart}if(i==">"){if(d.is_linespace(s.CharAtOffset(1))){s.SkipForward(2);K.contentStart=s.position;return BlockType.quote}s.SkipForward(1);K.contentStart=s.position;return BlockType.quote}if(i=="-"||i=="_"||i=="*"){var I=0;while(!s.eol()){var H=s.current();if(s.current()==i){I++;s.SkipForward(1);continue}if(d.is_linespace(s.current())){s.SkipForward(1);continue}break}if(s.eol()&&I>=3){return BlockType.hr}s.position=K.contentStart}if((i=="*"||i=="+"||i=="-")&&d.is_linespace(s.CharAtOffset(1))){s.SkipForward(1);s.SkipLinespace();K.contentStart=s.position;return BlockType.ul_li}if(d.is_digit(i)){s.SkipForward(1);while(d.is_digit(s.current())){s.SkipForward(1)}if(s.SkipChar(".")&&s.SkipLinespace()){K.contentStart=s.position;return BlockType.ol_li}s.position=K.contentStart}if(i=="["){var F=g.ParseLinkDefinition(s);if(F!=null){this.m_Markdown.AddLinkDefinition(F);return BlockType.Blank}}return BlockType.p};var u={};u.NA=0;u.Block=1;u.Span=2;u.Deep=3;u.Off=4;t.GetMarkdownMode=function(b){var i=b.attributes.markdown;if(i==undefined){if(this.m_bMarkdownInHtml){return u.Deep}else{return u.NA}}delete b.attributes.markdown;if(i=="1"){return(b.get_Flags()&HtmlTagFlags.ContentAsSpan)!=0?u.Span:u.Block}if(i=="block"){return u.Block}if(i=="deep"){return u.Deep}if(i=="span"){return u.Span}return u.Off};t.ProcessMarkdownEnabledHtml=function(n,H,F,G){var D=n.position;var E=1;var s=false;while(!n.eof()){if(!n.Find("<")){break}var K=n.position;var J=e.Parse(n);if(J==null){n.SkipForward(1);continue}if(this.m_Markdown.SafeMode&&G==u.Off&&!s){if(!J.IsSafe()){s=true}}if(J.closed){continue}if(J.name==F.name){if(J.closing){E--;if(E==0){n.SkipLinespace();n.SkipEol();H.blockType=BlockType.HtmlTag;H.data=F;H.contentEnd=n.position;switch(G){case u.Span:var I=this.CreateBlock();I.buf=n.buf;I.blockType=BlockType.span;I.contentStart=D;I.contentLen=K-D;H.children=new Array();H.children.push(I);break;case u.Block:case u.Deep:var i=new j(this.m_Markdown,G==u.Deep);H.children=i.ProcessRange(n.buf,D,K-D);break;case u.Off:if(s){H.blockType=BlockType.unsafe_html;H.contentEnd=n.position}else{var I=this.CreateBlock();I.buf=n.buf;I.blockType=BlockType.html;I.contentStart=D;I.contentLen=K-D;H.children=new Array();H.children.push(I)}break}return true}}else{E++}}}return false};t.ScanHtml=function(n,J){var K=n.position;var G=e.Parse(n);if(G==null){return false}if(G.closing){return false}var s=false;if(this.m_Markdown.SafeMode&&!G.IsSafe()){s=true}var D=G.get_Flags();if((D&HtmlTagFlags.Block)==0){return false}if((D&HtmlTagFlags.NoClosing)!=0||G.closed){n.SkipLinespace();n.SkipEol();J.contentLen=n.position-J.contentStart;J.blockType=s?BlockType.unsafe_html:BlockType.html;return true}if((D&HtmlTagFlags.Inline)!=0){n.SkipLinespace();if(!n.eol()){return false}}if(this.m_Markdown.ExtraMode){var L=this.GetMarkdownMode(G);if(L!=u.NA){return this.ProcessMarkdownEnabledHtml(n,J,G,L)}}var E=null;var F=1;while(!n.eof()){if(!n.Find("<")){break}var H=n.position;var M=e.Parse(n);if(M==null){n.SkipForward(1);continue}if(this.m_Markdown.SafeMode&&!M.IsSafe()){s=true}if(M.closed){continue}if(!M.closing&&this.m_Markdown.ExtraMode&&!s){var L=this.GetMarkdownMode(M);if(L!=u.NA){var i=this.CreateBlock();if(this.ProcessMarkdownEnabledHtml(n,i,M,L)){if(E==null){E=new Array()}if(H>K){var I=this.CreateBlock();I.buf=n.buf;I.blockType=BlockType.html;I.contentStart=K;I.contentLen=H-K;E.push(I)}E.push(i);K=n.position;continue}else{this.FreeBlock(i)}}}if(M.name==G.name&&!M.closed){if(M.closing){F--;if(F==0){n.SkipLinespace();n.SkipEol();if(s){J.blockType=BlockType.unsafe_html;J.contentEnd=n.position;return true}if(E!=null){if(n.position>K){var I=this.CreateBlock();I.buf=n.buf;I.blockType=BlockType.html;I.contentStart=K;I.contentLen=n.position-K;E.push(I)}J.blockType=BlockType.Composite;J.contentEnd=n.position;J.children=E;return true}J.blockType=BlockType.html;J.contentLen=n.position-J.contentStart;return true}}else{F++}}}return BlockType.Blank};t.BuildList=function(N){var K=N[0].blockType;var H=N[0].get_leadingSpaces();for(var D=1;D<N.length;D++){if((N[D].blockType==BlockType.p)&&(N[D-1].blockType==BlockType.p||N[D-1].blockType==K)){N[D-1].set_contentEnd(N[D].get_contentEnd());this.FreeBlock(N[D]);N.splice(D,1);D--;continue}if(N[D].blockType!=BlockType.indent&&N[D].blockType!=BlockType.Blank){var O=N[D].get_leadingSpaces();if(O>H){N[D].blockType=BlockType.indent;var J=N[D].get_contentEnd();N[D].contentStart=N[D].lineStart+O;N[D].set_contentEnd(J)}}}var M=this.CreateBlock();M.blockType=(K==BlockType.ul_li?BlockType.ul:BlockType.ol);M.children=new Array();for(var D=0;D<N.length;D++){var E=D;while(E>0&&N[E-1].blockType==BlockType.Blank){E--}var G=D;while(G<N.length-1&&N[G+1].blockType!=K){G++}if(E==G){M.children.push(this.CreateBlock().CopyFrom(N[D]))}else{var F=false;var I=this.m_Markdown.GetStringBuilder();for(var s=E;s<=G;s++){var p=N[s];I.Append(p.buf.substr(p.contentStart,p.contentLen));I.Append("\n");if(N[s].blockType==BlockType.Blank){F=true}}var L=this.CreateBlock();L.blockType=BlockType.li;var b=new j(this.m_Markdown);b.m_parentType=K;L.children=b.Process(I.ToString());if(!F){for(var D=0;D<L.children.length;D++){var n=L.children[D];if(n.blockType==BlockType.p){n.blockType=BlockType.span}}}M.children.push(L)}D=G}this.FreeBlocks(N);N.length=0;return M};this.Markdown=w;this.StringBuilder=l;this.SpanFormatter=m;this.StringScanner=k;this.BlockProcessor=j;this.LinkDefinition=g;this.HtmlTag=e;this.HtmlTagFlags=HtmlTagFlags;this.UnescapeString=r;this.BlockType=BlockType}();